const CONFIG={apiUrl:"https://dev-core.gamblio.ai",wsUrl:"ws://dev-core.gamblio.ai:8001"};const RECOMMENDATION_WIDGET_HTML_TEMPLATE=`<div id="game-container" class="{{STACK_MODE_CLASS}}">\n  {{VIDEO_HTML}} {{IMAGE_HTML}}\n  <button id="prev-btn" class="nav-btn swiper-button-prev"></button>\n  <div class="swiper{{SWIPER_STACK_MODE}}" id="games-swiper">\n    <div class="swiper-wrapper" id="slider"></div>\n  </div>\n  <button id="next-btn" class="nav-btn swiper-button-next"></button>\n</div>\n`;const RECOMMENDATION_WIDGET_CSS_TEMPLATE=`:root {\n  --card-shadow-color: {{SHADOW_COLOR}};\n  --gradient-color-1: {{GRADIENT_COLOR_1}};\n  --gradient-color-2: {{GRADIENT_COLOR_2}};\n  --gradient-direction: {{GRADIENT_DIRECTION}};\n  --nav-button-color: {{NAV_BUTTON_COLOR}};\n  --nav-button-hover-color: {{NAV_BUTTON_HOVER_COLOR}};\n}\n\n#game-container {\n  display: flex;\n  justify-content: center;\n  gap: 1rem;\n  width: 100%;\n  height: 100%;\n  padding-inline: 1rem;\n  position: relative;\n  {{BACKGROUND_STYLE}}\n}\n\n#game-container.stack-mode {\n  perspective: 1200px;\n}\n\n#game-container video {\n  position: absolute;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  object-fit: cover;\n  z-index: -1;\n}\n\n#game-container .background-image {\n  position: absolute;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  object-fit: cover;\n  z-index: -1;\n  pointer-events: none;\n}\n\n/* Swiper Container */\n.swiper {\n  width: 100%;\n  height: 100%;\n}\n\n.swiper.stack-mode {\n  width: 100%;\n  height: 100%;\n}\n\n.swiper-wrapper {\n  display: flex;\n  align-items: center;\n}\n\n.swiper-slide {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  width: auto !important;\n  height: calc(100% - 2rem);\n}\n\n/* Game Cards */\n.game {\n  width: auto;\n  height: 100%;\n  max-height: 100%;\n  aspect-ratio: 1;\n  position: relative;\n  border-radius: 12px;\n  overflow: hidden;\n  cursor: pointer;\n  box-shadow: 0 4px 16px var(--card-shadow-color);\n  transition: all 0.3s ease;\n}\n\n.game:hover {\n  transform: translateY(-8px);\n  box-shadow: 0 8px 24px var(--card-shadow-color);\n}\n\n.game img {\n  width: 100%;\n  height: 100%;\n  object-fit: cover;\n  border-radius: 12px;\n}\n\n.game::before {\n  content: "";\n  position: absolute;\n  inset: 0;\n  background: rgba(0, 0, 0, 0.7);\n  opacity: 0;\n  transition: opacity 0.3s ease;\n  z-index: 1;\n  border-radius: 12px;\n}\n\n.game:hover::before {\n  opacity: 1;\n}\n\n.game-hover-buttons {\n  position: absolute;\n  top: 50%;\n  left: 50%;\n  transform: translate(-50%, -50%);\n  display: flex;\n  flex-direction: column;\n  gap: 8px;\n  opacity: 0;\n  transition: opacity 0.3s ease;\n  z-index: 2;\n  pointer-events: none;\n  width: calc(100% - 16px);\n  height: 50%;\n  padding: 0 8px;\n}\n\n.game:hover .game-hover-buttons {\n  opacity: 1;\n  pointer-events: auto;\n}\n\n.game-hover-btn {\n  width: 100%;\n  flex: 1;\n  border: none;\n  border-radius: 6px;\n  font-size: clamp(16px, 2.5vw, 20px);\n  font-weight: 700;\n  text-transform: uppercase;\n  cursor: pointer;\n  transition: all 0.2s ease;\n  color: white;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  letter-spacing: 1px;\n  white-space: nowrap;\n}\n\n.game-hover-btn.demo-btn {\n  background: #808080 !important;\n  color: white !important;\n}\n\n.game-hover-btn.demo-btn:hover {\n  background: #6b6b6b !important;\n}\n\n.game-hover-btn.play-btn {\n  background: #e6c328 !important;\n  color: #002157 !important;\n}\n\n.game-hover-btn.play-btn:hover {\n  background: #f2c944 !important;\n}\n\n/* Navigation Buttons */\n.nav-btn {\n  position: relative;\n  z-index: 10;\n  background: transparent;\n  border: none;\n  border-radius: 50%;\n  width: 40px;\n  height: 40px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  cursor: pointer;\n  transition: all 0.3s ease;\n  flex-shrink: 0;\n}\n\n.swiper-button-prev::after,\n.swiper-button-next::after {\n  color: var(--nav-button-color);\n  font-size: 16px;\n  font-weight: bold;\n  transition: color 0.3s ease;\n}\n\n.swiper-button-prev:hover::after,\n.swiper-button-next:hover::after {\n  color: var(--nav-button-hover-color);\n}\n\n.nav-btn.swiper-button-disabled {\n  opacity: 0.35;\n  cursor: not-allowed;\n}\n\n.nav-btn.swiper-button-disabled:hover::after {\n  color: var(--nav-button-color);\n}\n\n/* Mobile Responsiveness */\n@media (max-width: 768px) {\n  #prev-btn,\n  #next-btn {\n    display: none !important;\n  }\n}\n\n/* Stack Mode - Half-Full-Half 3D Card Effect */\n.swiper.stack-mode .swiper-slide {\n  width: 100% !important;\n  max-width: 350px;\n  height: 100%;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  position: relative;\n  transition: transform 0.4s ease, opacity 0.4s ease;\n}\n\n.swiper.stack-mode .swiper-slide .game {\n  width: 100%;\n  height: 100%;\n  border-radius: 16px;\n  overflow: hidden;\n  position: relative;\n  transition: box-shadow 0.3s ease, transform 0.3s ease;\n}\n\n#game-container.stack-mode .game {\n  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.45);\n}\n\n#game-container.stack-mode .game:hover {\n  transform: none;\n  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.45);\n}\n\n.swiper.stack-mode .swiper-slide-prev,\n.swiper.stack-mode .swiper-slide-next {\n  z-index: 1;\n}\n\n.swiper.stack-mode .swiper-slide-prev .game,\n.swiper.stack-mode .swiper-slide-next .game {\n  transform: translateZ(-60px) scale(0.9);\n  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);\n}\n\n.swiper.stack-mode .swiper-slide-prev .game::after,\n.swiper.stack-mode .swiper-slide-next .game::after {\n  content: "";\n  position: absolute;\n  inset: 0;\n  background: linear-gradient(\n    180deg,\n    rgba(0, 0, 0, 0.60),\n    rgba(0, 0, 0, 0.7)\n  );\n  opacity: 0.85;\n  z-index: 3;\n  pointer-events: none;\n  transition: opacity 0.3s ease;\n}\n\n.swiper.stack-mode .swiper-slide:not(.swiper-slide-prev):not(.swiper-slide-active):not(.swiper-slide-next) {\n  opacity: 0;\n}\n\n.swiper.stack-mode .swiper-slide-active {\n  width: 100% !important;\n  max-width: 380px;\n  transform: translateZ(80px) scale(1.08);\n  z-index: 5;\n}\n\n.swiper.stack-mode .swiper-slide-active .game {\n  box-shadow: 0 20px 48px rgba(0, 0, 0, 0.55);\n}\n\n.swiper.stack-mode .swiper-slide-active .game::after {\n  content: "";\n  position: absolute;\n  inset: 0;\n  background: rgba(0, 0, 0, 0.50);\n  z-index: 3;\n  opacity: 0;\n  pointer-events: none;\n}\n\n.swiper.stack-mode .swiper-slide-prev .game-hover-buttons,\n.swiper.stack-mode .swiper-slide-next .game-hover-buttons {\n  opacity: 0;\n  pointer-events: none;\n}\n\n.swiper.stack-mode .swiper-slide-active:hover .game-hover-buttons {\n  opacity: 1;\n  pointer-events: auto;\n}\n\n.swiper.stack-mode .swiper-slide-active:hover .game::before {\n  opacity: 0.35;\n}\n\n`;class GamblioRecommendationWidget{static HTML="";static CSS="";static allGames=[];static currentIndex=0;static swiperInstance=null;static visibilityState=new Map;static lastActiveGameId=null;static observer=new IntersectionObserver(entries=>{entries.forEach(entry=>{const img=entry.target;const slideEl=img.closest(".swiper-slide");const isStackMode=Gamblio.displayMode==="stack";const isActiveSlide=slideEl?.classList.contains("swiper-slide-active")??false;const gameId=img.getAttribute("data-game-id");const game=GamblioRecommendationWidget.allGames.find(g=>String(g.normalizedId)===gameId);const stateKey=String(gameId);const wasVisible=GamblioRecommendationWidget.visibilityState.get(stateKey)===true;const isFullyVisible=entry.intersectionRatio>=1;const hasLeftViewport=!entry.isIntersecting;if(isStackMode&&!isActiveSlide){if(wasVisible){GamblioRecommendationWidget.visibilityState.set(stateKey,false)}return}if(!game){if(wasVisible&&hasLeftViewport){GamblioRecommendationWidget.visibilityState.set(stateKey,false)}return}if(isFullyVisible&&!wasVisible){GamblioRecommendationWidget.triggerImpression(game,{reason:"Fully visible in viewport; scheduling impression"})}else if(hasLeftViewport&&wasVisible){GamblioRecommendationWidget.visibilityState.set(stateKey,false)}})},{threshold:[0,1]});static triggerImpression(game,{reason:reason="Impression triggered",force:force=false}={}){if(!game){return}const stateKey=String(game.normalizedId);const wasVisible=GamblioRecommendationWidget.visibilityState.get(stateKey)===true;if(!force&&wasVisible){return}GamblioRecommendationWidget.visibilityState.set(stateKey,true);console.log(`[Gamblio][Recommendation] ${reason}`,{gameId:String(game.normalizedId),name:game.displayName});GamblioRecommendationWidget.addImpression(game.normalizedId)}static handleActiveStackSlide(swiper){const activeSlide=swiper.slides?.[swiper.activeIndex];if(!activeSlide)return;const img=activeSlide.querySelector("img[data-game-id]");if(!img)return;const gameId=img.getAttribute("data-game-id");const game=GamblioRecommendationWidget.allGames.find(g=>String(g.normalizedId)===gameId);if(GamblioRecommendationWidget.lastActiveGameId&&GamblioRecommendationWidget.lastActiveGameId!==gameId){GamblioRecommendationWidget.visibilityState.set(GamblioRecommendationWidget.lastActiveGameId,false)}GamblioRecommendationWidget.triggerImpression(game,{reason:"Active stack slide; scheduling impression"});GamblioRecommendationWidget.lastActiveGameId=gameId}static getBackgroundStyle(){const bgType=Gamblio.backgroundType;if(bgType==="gradient"){return"background: linear-gradient(var(--gradient-direction), var(--gradient-color-1), var(--gradient-color-2));"}else if(bgType==="video"||bgType==="image"){return"background: transparent;"}else{return"background: transparent;"}}static getVideoHTML(){if(Gamblio.backgroundType!=="video"){return""}const videoIndex=Gamblio.videoIndex||1;const videoFiles=[`video${videoIndex}.mp4`];const videoFile=videoFiles[videoIndex-1]||videoFiles[0];return`<video autoplay loop muted playsinline>\n      <source src="./videos/${videoFile}" type="video/mp4">\n    </video>`}static getImageHTML(){if(Gamblio.backgroundType!=="image"){return""}const imageIndex=Gamblio.imageIndex||1;const fileName=`image${imageIndex}.jpg`;return`<img class="background-image" src="./images/${fileName}" alt="Recommendation background image">`}static loadTemplate(){const isStackMode=Gamblio.displayMode==="stack";const htmlTemplate=RECOMMENDATION_WIDGET_HTML_TEMPLATE;const cssTemplate=RECOMMENDATION_WIDGET_CSS_TEMPLATE;const videoHTML=GamblioRecommendationWidget.getVideoHTML();const imageHTML=GamblioRecommendationWidget.getImageHTML();const stackModeClass=isStackMode?"stack-mode":"";const swiperStackMode=isStackMode?" stack-mode":"";GamblioRecommendationWidget.HTML=htmlTemplate.replace("{{STACK_MODE_CLASS}}",stackModeClass).replace("{{VIDEO_HTML}}",videoHTML).replace("{{IMAGE_HTML}}",imageHTML).replace("{{SWIPER_STACK_MODE}}",swiperStackMode);const backgroundStyle=GamblioRecommendationWidget.getBackgroundStyle();GamblioRecommendationWidget.CSS=cssTemplate.replace("{{SHADOW_COLOR}}",Gamblio.shadowColor).replace("{{GRADIENT_COLOR_1}}",Gamblio.gradientColors[0]).replace("{{GRADIENT_COLOR_2}}",Gamblio.gradientColors[1]).replace("{{GRADIENT_DIRECTION}}",Gamblio.gradientDirection).replace("{{NAV_BUTTON_COLOR}}",Gamblio.navButtonColor).replace("{{NAV_BUTTON_HOVER_COLOR}}",Gamblio.navButtonHoverColor).replace("{{BACKGROUND_STYLE}}",backgroundStyle);return true}static async init(){const templateLoaded=GamblioRecommendationWidget.loadTemplate();if(!templateLoaded)return;const res=await GamblioRecommendationWidget.getRecommendedGames();if(!res)return;const swiperCSS=document.createElement("link");swiperCSS.rel="stylesheet";swiperCSS.href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css";document.head.appendChild(swiperCSS);const swiperScript=document.createElement("script");swiperScript.src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js";swiperScript.onload=()=>{document.head.insertAdjacentHTML("beforeend",`<style>${GamblioRecommendationWidget.CSS}</style>`);document.getElementById(Gamblio.recommendationWidgetTargetContainerId).innerHTML=GamblioRecommendationWidget.HTML;setTimeout(()=>{GamblioRecommendationWidget.allGames=res.map(g=>{const normalizedId=g.id??g.gameId;const displayName=g.gameName||g.name||`Game ${normalizedId}`;return{...g,normalizedId:normalizedId,displayName:displayName}});GamblioRecommendationWidget.visibilityState.clear();GamblioRecommendationWidget.allGames.forEach(game=>{GamblioRecommendationWidget.visibilityState.set(String(game.normalizedId),false)});GamblioRecommendationWidget.lastActiveGameId=null;GamblioRecommendationWidget.renderCarousel();GamblioRecommendationWidget.initSwiper()},300)};document.head.appendChild(swiperScript)}static buildGameUrl(mode,gameId){const url=Gamblio.gamePlayUrl;return url.replace("{mode}",mode).replace("{gameId}",gameId)}static async getRecommendedGames(){try{const response=await fetch(`${CONFIG.apiUrl}/recommendation/`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({clientId:btoa(String(Gamblio.clientId)),playerToken:Gamblio.token})});if(!response.ok)throw new Error("Failed to load games");const res=await response.json();return res.data||res}catch(err){console.error("Error fetching games:",err);return[]}}static renderCarousel(){const slider=document.getElementById("slider");slider.innerHTML="";GamblioRecommendationWidget.allGames.forEach(game=>{const gameId=game.normalizedId;const gameName=game.displayName;const gameImage=game.gameImage||game.logo;GamblioRecommendationWidget.visibilityState.set(String(gameId),GamblioRecommendationWidget.visibilityState.get(String(gameId))===true);const slideEl=document.createElement("div");slideEl.classList.add("swiper-slide");slideEl.innerHTML=`\n        <div class="game">\n          <img src="${gameImage}" alt="${gameName}" data-game-id="${gameId}">\n          <div class="game-hover-buttons">\n            <button class="game-hover-btn demo-btn" data-action="demo">Demo</button>\n            <button class="game-hover-btn play-btn" data-action="play">Play</button>\n          </div>\n        </div>\n      `;const demoBtn=slideEl.querySelector(".demo-btn");const playBtn=slideEl.querySelector(".play-btn");demoBtn.addEventListener("click",e=>{e.stopPropagation();console.log("[Gamblio][Recommendation] Demo button clicked",{gameId:gameId,name:gameName});const demoUrl=GamblioRecommendationWidget.buildGameUrl("demo",gameId);window.location.href=demoUrl});playBtn.addEventListener("click",e=>{e.stopPropagation();console.log("[Gamblio][Recommendation] Play button clicked",{gameId:game.normalizedId,name:gameName});GamblioRecommendationWidget.addClick(game.normalizedId);const playUrl=GamblioRecommendationWidget.buildGameUrl("cash",gameId);window.location.href=playUrl});slider.appendChild(slideEl);GamblioRecommendationWidget.observer.observe(slideEl.querySelector("img"))})}static initSwiper(){const swiperContainer=document.getElementById("games-swiper");const gameContainer=document.getElementById("game-container");const requestedMode=Gamblio.displayMode||"carousel";const totalGames=GamblioRecommendationWidget.allGames.length;const effectiveMode=requestedMode==="stack"&&totalGames>=3?"stack":"carousel";if(effectiveMode==="stack"){swiperContainer.classList.add("stack-mode");gameContainer?.classList.add("stack-mode")}if(effectiveMode!=="stack"){swiperContainer.classList.remove("stack-mode");gameContainer?.classList.remove("stack-mode")}const swiperConfig={slidesPerView:"auto",spaceBetween:16,navigation:{nextEl:"#next-btn",prevEl:"#prev-btn"},keyboard:{enabled:true},mousewheel:{forceToAxis:true}};if(effectiveMode==="carousel"){swiperConfig.breakpoints={320:{spaceBetween:12},768:{spaceBetween:16},1024:{spaceBetween:20}}}if(effectiveMode==="stack"){swiperConfig.slidesPerView="auto";swiperConfig.loop=totalGames>3;swiperConfig.effect="coverflow";swiperConfig.grabCursor=true;swiperConfig.centeredSlides=true;swiperConfig.spaceBetween=0;swiperConfig.mousewheel=false;swiperConfig.coverflowEffect={rotate:0,stretch:0,depth:360,modifier:1.15,slideShadows:false}}const swiper=new Swiper("#games-swiper",swiperConfig);GamblioRecommendationWidget.swiperInstance=swiper;if(effectiveMode==="stack"){GamblioRecommendationWidget.handleActiveStackSlide(swiper);swiper.on("slideChange",()=>{GamblioRecommendationWidget.handleActiveStackSlide(swiper)})}else{GamblioRecommendationWidget.swiperInstance=null}}static async addImpression(gameId){console.log("[Gamblio][Recommendation] Sending impression",{gameId:gameId});try{const response=await fetch(`${CONFIG.apiUrl}/recommendation/impression/`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({clientId:btoa(String(Gamblio.clientId)),playerToken:Gamblio.token,gameId:gameId})});if(!response.ok)throw new Error(`HTTP ${response.status}`);console.log("[Gamblio][Recommendation] Impression recorded",{gameId:gameId})}catch(error){console.warn("[Gamblio][Recommendation] Impression failed",{gameId:gameId,error:error.message})}}static async addClick(gameId){try{const response=await fetch(`${CONFIG.apiUrl}/recommendation/click/`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({clientId:btoa(String(Gamblio.clientId)),playerToken:Gamblio.token,gameId:gameId})});if(!response.ok)throw new Error(`HTTP ${response.status}`);console.log("[Gamblio][Recommendation] Click recorded",{gameId:gameId})}catch(error){console.warn("[Gamblio][Recommendation] Click failed",{gameId:gameId,error:error.message});throw error}}}const CHAT_WIDGET_HTML_TEMPLATE=`<button\n  class="chat-toggle"\n  id="chatToggle"\n  aria-label="Open chat with Admiral Bot"\n  aria-expanded="false"\n  aria-controls="chatContainer"\n>\n  <svg\n    viewBox="0 0 24 24"\n    xmlns="http://www.w3.org/2000/svg"\n    role="img"\n    aria-hidden="true"\n  >\n    <path\n      d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM20 16H5.17L4 17.17V4H20V16Z"\n    ></path>\n    <circle cx="7" cy="10" r="1"></circle>\n    <circle cx="12" cy="10" r="1"></circle>\n    <circle cx="17" cy="10" r="1"></circle>\n  </svg>\n</button>\n<div\n  class="nx-chat-container"\n  id="chatContainer"\n  role="dialog"\n  aria-label="Admiral Bot Chat"\n  aria-hidden="true"\n>\n  <div class="nx-chat-header">\n    <div class="nx-chat-header-content">\n      <img src="{{LOGO_URL}}" alt="Logo" {{LOGO_STYLE}} />\n      <div id="typingBubble" class="typing-bubble" aria-hidden="true">\n        <div class="typing-dots">\n          <span></span>\n          <span></span>\n          <span></span>\n        </div>\n      </div>\n    </div>\n    <div class="chat-navigation">\n      <button id="endChat" type="button" class="end-chat" style="display: none">\n        End chat\n      </button>\n      <button\n        class="nx-chat-close"\n        id="chatClose"\n        type="button"\n        aria-label="Close chat"\n      >\n        <svg\n          viewBox="0 0 24 24"\n          xmlns="http://www.w3.org/2000/svg"\n          role="img"\n          aria-hidden="true"\n        >\n          <path\n            d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"\n          ></path>\n        </svg>\n      </button>\n    </div>\n  </div>\n  <div class="nx-chat-body" role="log" aria-live="polite">\n    <div id="preChatContainer" class="pre-chat-container">\n      <label for="preChatInput">Enter your name, ID or email (optional)</label>\n      <input\n        id="preChatInput"\n        type="text"\n        class="pre-chat-input"\n        autocomplete="off"\n        placeholder="Enter your name or email..."\n        oninput="this.value = this.value.replace(/[^a-zA-Z0-9@.\\s_-]/g, '')"\n      />\n      <input\n        id="preChatPlayerId"\n        type="number"\n        class="pre-chat-input"\n        autocomplete="off"\n        placeholder="Enter player ID..."\n        oninput="this.value = this.value.replace(/[^0-9]/g, '')"\n        style="display: none"\n      />\n      <button id="startChatButton" type="submit" class="pre-chat-button">\n        Start Chat\n      </button>\n    </div>\n    <div class="messages" id="messagesContainer"></div>\n  </div>\n  <div id="nxChatFooter" class="nx-chat-footer">\n    <div\n      id="chatClosedMessage"\n      class="chat-closed-message"\n      style="text-align: center; display: none; width: 100%"\n    >\n      <p>This chat is closed</p>\n      <button\n        id="reopenChatButton"\n        style="\n          margin-top: 0px;\n          padding: 8px 16px;\n          border: none;\n          border-radius: 6px;\n          cursor: pointer;\n        "\n      >\n        Reopen chat\n      </button>\n      <div\n        id="chatRatingContainer"\n        class="chat-rating hidden"\n        role="group"\n        aria-labelledby="chatRatingTitle"\n      >\n        <p id="chatRatingTitle">Rate your chat experience</p>\n        <div\n          class="star-rating"\n          role="radiogroup"\n          aria-labelledby="chatRatingTitle"\n        >\n          <button\n            type="button"\n            class="star"\n            data-rating="1"\n            aria-label="1 star"\n            aria-pressed="false"\n          >\n            ★\n          </button>\n          <button\n            type="button"\n            class="star"\n            data-rating="2"\n            aria-label="2 stars"\n            aria-pressed="false"\n          >\n            ★\n          </button>\n          <button\n            type="button"\n            class="star"\n            data-rating="3"\n            aria-label="3 stars"\n            aria-pressed="false"\n          >\n            ★\n          </button>\n          <button\n            type="button"\n            class="star"\n            data-rating="4"\n            aria-label="4 stars"\n            aria-pressed="false"\n          >\n            ★\n          </button>\n          <button\n            type="button"\n            class="star"\n            data-rating="5"\n            aria-label="5 stars"\n            aria-pressed="false"\n          >\n            ★\n          </button>\n        </div>\n        <div class="rating-actions">\n          <button\n            id="submitRatingButton"\n            class="submit-rating"\n            type="button"\n            disabled\n          >\n            Submit review\n          </button>\n          <button id="skipRatingButton" class="skip-rating" type="button">\n            Skip\n          </button>\n        </div>\n        <div id="ratingThanks" class="rating-thanks hidden">\n          Thanks for your feedback!\n        </div>\n      </div>\n    </div>\n    <div\n      id="filePreview"\n      class="file-preview"\n      style="\n        display: none;\n        padding: 8px;\n        background: #f5f5f5;\n        border-radius: 8px;\n        margin-bottom: 8px;\n      "\n    >\n      <div\n        class="file-preview-content"\n        style="display: flex; align-items: center; gap: 8px"\n      >\n        <img\n          id="previewImage"\n          src="/placeholder.svg"\n          alt="Preview"\n          style="\n            max-width: 60px;\n            max-height: 60px;\n            border-radius: 4px;\n            object-fit: cover;\n          "\n        />\n        <span style="flex: 1; font-size: 14px; color: #666"\n          >Image selected</span\n        >\n        <button\n          id="removeFile"\n          class="remove-file-btn"\n          style="\n            padding: 4px 8px;\n            background: #ff4444;\n            color: white;\n            border: none;\n            border-radius: 4px;\n            cursor: pointer;\n            font-size: 12px;\n          "\n        >\n          Remove\n        </button>\n      </div>\n    </div>\n    <div\n      id="messageForm"\n      style="display: flex; width: 100%; align-items: center; gap: 4px"\n    >\n      <input\n        type="text"\n        autocomplete="off"\n        class="nx-chat-input"\n        placeholder="Connecting..."\n        id="chatInput"\n        aria-label="Message input"\n      />\n      <button id="emojiButton" class="emoji-button" title="Add emoji">\n        <svg\n          viewBox="0 0 24 24"\n          width="20"\n          height="20"\n          xmlns="http://www.w3.org/2000/svg"\n          role="img"\n          aria-hidden="true"\n          fill="white"\n        >\n          <path\n            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"\n          />\n          <circle cx="8.5" cy="10.5" r="1.5" />\n          <circle cx="15.5" cy="10.5" r="1.5" />\n          <path\n            d="M12 17.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"\n          />\n        </svg>\n      </button>\n      <emoji-picker\n        id="emojiPicker"\n        style="\n          display: none;\n          position: absolute;\n          bottom: 100%;\n          right: 0;\n          z-index: 1000;\n          margin-bottom: 8px;\n        "\n      ></emoji-picker>\n      <label class="file-upload-btn" style="display: flex; align-items: center">\n        <input\n          type="file"\n          accept="image/*"\n          style="display: none"\n          id="fileInput"\n        />\n        <div class="file-upload-icon">\n          <svg\n            viewBox="0 0 24 24"\n            width="20"\n            height="20"\n            xmlns="http://www.w3.org/2000/svg"\n            role="img"\n            aria-hidden="true"\n            fill="currentColor"\n          >\n            <path\n              d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"\n            />\n          </svg>\n        </div>\n      </label>\n      <button\n        class="send-button"\n        id="sendButton"\n        aria-label="Send message"\n        disabled\n      >\n        <svg\n          viewBox="0 0 24 24"\n          xmlns="http://www.w3.org/2000/svg"\n          role="img"\n          aria-hidden="true"\n        >\n          <path\n            fill-rule="evenodd"\n            clip-rule="evenodd"\n            d="M3.3938 2.20468C3.70395 1.96828 4.12324 1.93374 4.4679 2.1162L21.4679 11.1162C21.7953 11.2895 22 11.6296 22 12C22 12.3704 21.7953 12.7105 21.4679 12.8838L4.4679 21.8838C4.12324 22.0662 3.70395 22.0317 3.3938 21.7953C3.08365 21.5589 2.93922 21.1637 3.02382 20.7831L4.97561 12L3.02382 3.21692C2.93922 2.83623 3.08365 2.44109 3.3938 2.20468ZM6.80218 13L5.44596 19.103L16.9739 13H6.80218ZM16.9739 11H6.80218L5.44596 4.89699L16.9739 11Z"\n          />\n        </svg>\n      </button>\n    </div>\n  </div>\n  <div class="powered-by">\n    <span>Powered by</span>\n    <img\n      src="https://app.gamblio.ai/logo-dark.svg"\n      alt="Gamblio logo"\n      style="width: 15px; height: 15px"\n    />\n    <a href="https://gamblio.ai" target="_blank">Gamblio</a>\n  </div>\n</div>\n`;const CHAT_WIDGET_CSS_TEMPLATE=`:root {\n  --chat-toggle-bg: {{BACKGROUND_PRIMARY}};\n  --chat-toggle-hover: {{HOVER_COLOR}};\n}\n\n.chat-toggle,\n.nx-chat-container {\n  font-family: "Geist", sans-serif;\n}\n\n.chat-toggle {\n  position: fixed;\n  bottom: 20px;\n  right: 20px;\n  width: 60px;\n  height: 60px;\n  background: var(--chat-toggle-bg);\n  border-radius: 50%;\n  border: none;\n  color: #ffffff;\n  cursor: pointer;\n  box-shadow: 0 4px 20px rgba(0, 33, 87, 0.3);\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  z-index: 1001;\n  transition: transform 0.3s ease, box-shadow 0.3s ease;\n}\n\n.chat-toggle:hover {\n  transform: scale(1.1);\n  box-shadow: 0 6px 26px rgba(0, 33, 87, 0.4);\n}\n\n.chat-toggle svg {\n  width: 28px;\n  height: 28px;\n  fill: currentColor;\n  transition: transform 0.3s ease;\n}\n\n.chat-toggle.active svg {\n  transform: rotate(45deg);\n}\n\n.nx-chat-container {\n  position: fixed;\n  bottom: 90px;\n  right: 20px;\n  width: 380px;\n  height: 500px;\n  background: #ffffff;\n  border: 1px solid #e6e6e6;\n  border-radius: 12px;\n  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.18);\n  display: flex;\n  flex-direction: column;\n  transform: translateY(20px) scale(0.95);\n  opacity: 0;\n  visibility: hidden;\n  pointer-events: none;\n  transition: transform 0.3s ease, opacity 0.3s ease, visibility 0.3s ease;\n  z-index: 1000;\n  overflow: hidden;\n}\n\n.nx-chat-container.open {\n  transform: translateY(0) scale(1);\n  opacity: 1;\n  visibility: visible;\n  pointer-events: auto;\n}\n\n.nx-chat-container,\n.nx-chat-container * {\n  box-sizing: border-box;\n  font-family: "Geist", sans-serif;\n}\n\n.nx-chat-header {\n  background: var(--chat-toggle-bg);\n  color: #ffffff;\n  padding: 16px 20px;\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  border-radius: 12px 12px 0 0;\n}\n\n.nx-chat-header-content {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  gap: 8px;\n}\n\n.nx-chat-header img {\n  width: 110px;\n  height: auto;\n}\n\n.chat-navigation {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n}\n\n.nx-chat-close,\n.end-chat {\n  background: none;\n  border: none;\n  color: inherit;\n  cursor: pointer;\n  padding: 4px 8px;\n  border-radius: 12px;\n  transition: background-color 0.2s ease;\n  display: flex;\n  align-items: center;\n  gap: 4px;\n}\n\n.end-chat {\n  border: 1px solid rgba(255, 255, 255, 0.8);\n  font-size: 0.8rem;\n}\n\n.nx-chat-close:hover,\n.end-chat:hover {\n  background-color: rgba(255, 255, 255, 0.12);\n}\n\n.nx-chat-close svg {\n  width: 20px;\n  height: 20px;\n  fill: currentColor;\n}\n\n.nx-chat-body {\n  flex: 1;\n  background: #fafafa;\n  padding: 16px 20px;\n  display: flex;\n  flex-direction: column;\n  gap: 16px;\n  overflow-y: auto;\n}\n\n.nx-chat-body::-webkit-scrollbar {\n  width: 0;\n  height: 0;\n}\n\n.pre-chat-container {\n  display: flex;\n  flex-direction: column;\n  gap: 12px;\n  background: #ffffff;\n  border-radius: 12px;\n  border: 1px solid #e6e6e6;\n  padding: 20px;\n  box-shadow: 0 12px 28px rgba(0, 33, 87, 0.12);\n  text-align: center;\n}\n\n.pre-chat-container label {\n  font-size: 0.9rem;\n  color: #2b2b2b;\n}\n\n.pre-chat-input {\n  border: 1px solid #dcdcdc;\n  border-radius: 20px;\n  padding: 12px 16px;\n  font-size: 0.95rem;\n}\n\n.pre-chat-input:focus {\n  outline: none;\n  border-color: var(--chat-toggle-bg);\n  box-shadow: 0 0 0 1px rgba(0, 33, 87, 0.15);\n}\n\n.pre-chat-button {\n  border: none;\n  border-radius: 20px;\n  padding: 12px 20px;\n  background: var(--chat-toggle-bg);\n  color: #ffffff;\n  font-size: 0.95rem;\n  cursor: pointer;\n  transition: background 0.2s ease, transform 0.2s ease;\n}\n\n.pre-chat-button:hover {\n  background: var(--chat-toggle-hover);\n  transform: scale(1.03);\n}\n\n.messages {\n  display: flex;\n  flex-direction: column;\n  gap: 12px;\n  flex: 1;\n  min-height: 0;\n}\n\n.message-wrapper {\n  display: flex;\n  flex-direction: row-reverse;\n  align-items: center;\n  gap: 6px;\n  margin-bottom: 8px;\n}\n\n.message-wrapper.bot {\n  justify-content: flex-end;\n}\n\n.message-with-indicator {\n  display: flex;\n  flex-direction: column;\n  align-items: flex-end;\n}\n\n.delivery-indicator {\n  display: flex;\n  align-items: center;\n  justify-content: flex-end;\n  margin-top: 2px;\n  padding-right: 4px;\n  height: 14px;\n}\n\n.checkmark-icon {\n  font-size: 0.75rem;\n  line-height: 1;\n  color: #888;\n  user-select: none;\n  cursor: default;\n  transition: color 0.2s ease;\n  font-weight: 500;\n  letter-spacing: -0.5px;\n}\n\n.checkmark-icon.sent {\n  color: #888;\n}\n\n.checkmark-icon.delivered {\n  color: var(--chat-toggle-bg);\n}\n\n.checkmark-icon:hover {\n  opacity: 0.8;\n}\n\n.message {\n  padding: 10px 14px;\n  border-radius: 14px;\n  line-height: 1.45;\n  font-size: 0.95rem;\n  background: #ffffff;\n  color: #2c2c2c;\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);\n}\n\n.message.user {\n  background: var(--chat-toggle-bg);\n  color: #ffffff;\n  border-bottom-right-radius: 4px;\n}\n\n.message.bot {\n  border-bottom-left-radius: 4px;\n}\n\n.message img {\n  margin-top: 8px;\n  border-radius: 8px;\n  max-width: 220px;\n  width: 100%;\n  height: auto;\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);\n  cursor: pointer;\n}\n\n.timestamp {\n  font-size: 0.75rem;\n  color: #888;\n  white-space: nowrap;\n}\n\n.nx-chat-footer {\n  display: flex;\n  flex-direction: column;\n  gap: 8px;\n  padding: 16px 6px;\n  border-top: 1px solid #e6e6e6;\n  background: #ffffff;\n  border-radius: 0 0 12px 12px;\n}\n\n.chat-closed-message {\n  text-align: center;\n}\n\n.chat-closed-message button {\n  margin-top: 8px;\n  border: none;\n  border-radius: 20px;\n  padding: 8px 16px;\n  background: var(--chat-toggle-bg);\n  color: #ffffff;\n  cursor: pointer;\n  transition: background 0.2s ease;\n}\n\n\n.file-preview {\n  display: none;\n  border: 1px solid #e6e6e6;\n  border-radius: 8px;\n  background: #f5f5f5;\n  padding: 10px 14px;\n}\n\n.file-preview-content {\n  display: flex;\n  align-items: center;\n  gap: 12px;\n}\n\n.file-preview img {\n  width: 48px;\n  height: 48px;\n  border-radius: 6px;\n  object-fit: cover;\n  border: 1px solid #dcdcdc;\n}\n\n.remove-file-btn {\n  background: #c0392b;\n  color: #ffffff;\n  border: none;\n  border-radius: 6px;\n  padding: 6px 12px;\n  font-size: 0.8rem;\n  cursor: pointer;\n  transition: background 0.2s ease;\n}\n\n.remove-file-btn:hover {\n  background: #962d22;\n}\n\n.message-form {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  position: relative;\n}\n\n.nx-chat-input {\n  flex: 1;\n  border: 1px solid #dcdcdc;\n  border-radius: 20px;\n  padding: 12px 16px;\n  font-size: 0.95rem;\n}\n\n.nx-chat-input:focus {\n  outline: none;\n  border-color: var(--chat-toggle-bg);\n  box-shadow: 0 0 0 1px rgba(0, 33, 87, 0.2);\n}\n\n.emoji-button,\n.file-upload-icon,\n.send-button {\n  width: 36px;\n  height: 36px;\n  border-radius: 50%;\n  background: var(--chat-toggle-bg);\n  border: none;\n  color: #ffffff;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  cursor: pointer;\n  transition: background 0.2s ease, transform 0.2s ease;\n}\n\n.emoji-button:hover,\n.file-upload-icon:hover,\n.send-button:hover {\n  background: var(--chat-toggle-hover);\n  transform: scale(1.05);\n}\n\n.emoji-button svg,\n.file-upload-icon svg,\n.send-button svg {\n  width: 20px;\n  height: 20px;\n  fill: currentColor;\n}\n\n.file-upload-btn input {\n  display: none;\n}\n\n.typing-bubble {\n  display: none;\n  align-items: center;\n  gap: 6px;\n  font-size: 0.85rem;\n  color: rgba(255, 255, 255, 0.9);\n}\n\n.typing-dots {\n  display: flex;\n  gap: 4px;\n}\n\n.typing-dots span {\n  width: 6px;\n  height: 6px;\n  background: #fecc00;\n  border-radius: 50%;\n  animation: typing-dot 1.2s infinite ease-in-out;\n}\n\n.typing-dots span:nth-child(2) {\n  animation-delay: 0.2s;\n}\n\n.typing-dots span:nth-child(3) {\n  animation-delay: 0.4s;\n}\n\n@keyframes typing-dot {\n  0%, 80%, 100% {\n    transform: scale(0.7);\n    opacity: 0.5;\n  }\n  40% {\n    transform: scale(1);\n    opacity: 1;\n  }\n}\n\n.nx-date-separator {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  margin: 8px 0;\n}\n\n.nx-separator-line {\n  height: 1px;\n  background: #e6e6e6;\n  flex: 1;\n}\n\n.nx-date-separator-label {\n  font-size: 12px;\n  color: #666;\n  white-space: nowrap;\n}\n\nemoji-picker {\n  position: absolute;\n  bottom: 48px;\n  right: 0;\n  z-index: 2000;\n  max-height: 260px;\n  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);\n}\n\n@media (max-width: 768px) {\n  .nx-chat-container {\n    width: calc(100% - 24px);\n    bottom: 80px;\n    right: 12px;\n    left: 12px;\n    height: 70vh;\n  }\n\n  .chat-toggle {\n    bottom: 16px;\n    right: 16px;\n  }\n\n  .message-wrapper {\n    max-width: 90%;\n  }\n\n  .message img {\n    max-width: 160px;\n  }\n}\n\n@media (max-width: 480px) {\n  .nx-chat-container {\n    width: calc(100% - 16px);\n    right: 8px;\n    left: 8px;\n    bottom: 70px;\n    height: 65vh;\n  }\n\n  .message img {\n    max-width: 120px;\n  }\n}\n\n.hidden {\n  display: none !important;\n}\n\n.chat-rating {\n  margin-top: 16px;\n  padding: 16px;\n  background: rgba(15, 23, 42, 0.08);\n  border-radius: 12px;\n  color: #0f172a;\n  animation: fadeIn 0.25s ease-out;\n}\n\n.chat-rating p {\n  margin-bottom: 8px;\n  font-weight: 600;\n}\n\n.star-rating {\n  display: flex;\n  justify-content: center;\n  gap: 8px;\n  margin: 12px 0;\n}\n\n.star-rating .star {\n  border: none;\n  background: none;\n  font-size: 28px;\n  color: #d1d5db;\n  cursor: pointer;\n  transition: transform 0.15s ease, color 0.15s ease;\n}\n\n.star-rating .star:hover,\n.star-rating .star:focus-visible {\n  transform: scale(1.15);\n  color: #facc15;\n  outline: none;\n}\n\n.star-rating .star.is-active {\n  color: #facc15;\n}\n\n.rating-actions {\n  display: flex;\n  justify-content: center;\n  gap: 12px;\n  margin-top: 12px;\n  flex-wrap: wrap;\n}\n\n.submit-rating,\n.skip-rating {\n  padding: 8px 16px;\n  border-radius: 9999px;\n  border: none;\n  cursor: pointer;\n  font-weight: 600;\n  transition: transform 0.15s ease, box-shadow 0.15s ease;\n}\n\n.submit-rating {\n  background: linear-gradient(135deg, #facc15, #f59e0b);\n  color: #1f2937;\n  box-shadow: 0 8px 20px rgba(250, 204, 21, 0.35);\n}\n\n.submit-rating:disabled {\n  opacity: 0.6;\n  cursor: not-allowed;\n  box-shadow: none;\n}\n\n.skip-rating {\n  background: transparent;\n  color: #1f2937;\n  border: 1px solid rgba(15, 23, 42, 0.25);\n}\n\n.submit-rating:hover:enabled,\n.skip-rating:hover {\n  transform: translateY(-1px);\n  box-shadow: 0 6px 14px rgba(15, 23, 42, 0.15);\n}\n\n.rating-thanks {\n  margin-top: 16px;\n  font-weight: 600;\n  color: #16a34a;\n}\n\n@keyframes fadeIn {\n  from {\n    opacity: 0;\n    transform: translateY(6px);\n  }\n  to {\n    opacity: 1;\n    transform: translateY(0);\n  }\n}\n\n.powered-by {\n  background: var(--chat-toggle-bg);\n  color: rgba(255, 255, 255, 0.75);\n  letter-spacing: 0.8px;\n  text-align: center;\n  font-size: 10px;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  gap: 6px;\n  padding: 10px 16px;\n  text-transform: uppercase;\n  border-top: 1px solid rgba(255, 255, 255, 0.08);\n  backdrop-filter: blur(8px);\n}\n\n.powered-by a {\n  color: rgba(255, 255, 255, 0.95);\n  font-weight: 600;\n  text-decoration: none;\n  transition: color 0.2s ease;\n}\n\n.powered-by a:hover {\n  color: #ffffff;\n}\n\n.powered-by img {\n  opacity: 0.9;\n  transition: opacity 0.2s ease;\n}\n\n.powered-by:hover img {\n  opacity: 1;\n}\n\n`;class GamblioChatWidget{static isUsingDefaults(){const defaultBgPrimary="#0292a0";const defaultLogoUrl="https://app.gamblio.ai/logo-dark.svg";return Gamblio.backgroundPrimary===defaultBgPrimary&&Gamblio.logoUrl===defaultLogoUrl}static get HTML(){const logoStyle=GamblioChatWidget.isUsingDefaults()?'style="mix-blend-mode: screen;"':"";const htmlTemplate=CHAT_WIDGET_HTML_TEMPLATE;return htmlTemplate.replace("{{LOGO_URL}}",Gamblio.logoUrl).replace("{{LOGO_STYLE}}",logoStyle)}static get CSS(){const cssTemplate=CHAT_WIDGET_CSS_TEMPLATE;return cssTemplate.replace("{{BACKGROUND_PRIMARY}}",Gamblio.backgroundPrimary||"#0292a0").replace("{{HOVER_COLOR}}",Gamblio.hoverColor||"#0292a0")}static hasInitialized=false;static token="";static clientId=null;static playerName="";static playerId=null;static messages=[];static isSending=false;static shouldAutoScroll=true;static selectedFile=null;static previewObjectUrl=null;static typingTimeoutId=null;static elements={};static documentClickHandler=null;static visibilityObserver=null;static visibleIdsSet=new Set;static seenIdsSet=new Set;static visibilityTimeout=null;static selectedRatingValue=0;static hasSubmittedRating=false;static markdownConverter=null;static init(){if(GamblioChatWidget.hasInitialized){return}GamblioChatWidget.hasInitialized=true;GamblioChatWidget.token=Gamblio.token||"";GamblioChatWidget.clientId=Gamblio.clientId??null;GamblioChatWidget.playerName=GamblioChatWidget.generateGuestName();GamblioChatWidget.injectAssets();GamblioChatWidget.cacheElements();GamblioChatWidget.resetUi();GamblioChatWidget.setupEventListeners();GamblioChatWidget.ensureEmojiPicker();GamblioChatWidget.ensureMarkdownConverter();window.addEventListener("beforeunload",GamblioChatWidget.handleBeforeUnload)}static injectAssets(){if(!document.getElementById("gamblio-chat-widget-style")){const style=document.createElement("style");style.id="gamblio-chat-widget-style";style.textContent=GamblioChatWidget.CSS;document.head.appendChild(style)}if(!document.getElementById("chatContainer")){const wrapper=document.createElement("div");wrapper.innerHTML=GamblioChatWidget.HTML.trim();while(wrapper.firstChild){document.body.appendChild(wrapper.firstChild)}}}static cacheElements(){GamblioChatWidget.elements={chatToggle:document.getElementById("chatToggle"),chatContainer:document.getElementById("chatContainer"),chatClose:document.getElementById("chatClose"),chatInput:document.getElementById("chatInput"),sendButton:document.getElementById("sendButton"),chatFooter:document.getElementById("nxChatFooter"),preChatContainer:document.getElementById("preChatContainer"),preChatInput:document.getElementById("preChatInput"),preChatPlayerId:document.getElementById("preChatPlayerId"),startChatButton:document.getElementById("startChatButton"),endChatButton:document.getElementById("endChat"),reopenChatButton:document.getElementById("reopenChatButton"),chatClosedMessage:document.getElementById("chatClosedMessage"),messagesContainer:document.getElementById("messagesContainer"),typingBubble:document.getElementById("typingBubble"),emojiButton:document.getElementById("emojiButton"),emojiPicker:document.getElementById("emojiPicker"),fileInput:document.getElementById("fileInput"),filePreview:document.getElementById("filePreview"),previewImage:document.getElementById("previewImage"),removeFile:document.getElementById("removeFile"),messageForm:document.getElementById("messageForm"),chatBody:document.querySelector(".nx-chat-body"),ratingContainer:document.getElementById("chatRatingContainer"),ratingSubmitButton:document.getElementById("submitRatingButton"),ratingSkipButton:document.getElementById("skipRatingButton"),ratingThanksMessage:document.getElementById("ratingThanks")}}static resetUi(){GamblioChatWidget.destroySocket();GamblioChatWidget.messages=[];GamblioChatWidget.chatId=null;GamblioChatWidget.shouldAutoScroll=true;GamblioChatWidget.isSending=false;GamblioChatWidget.selectedFile=null;GamblioChatWidget.clearTypingIndicator();const el=GamblioChatWidget.elements;if(el.messagesContainer){el.messagesContainer.innerHTML=""}if(el.chatClosedMessage){el.chatClosedMessage.style.display="none"}if(el.messageForm){el.messageForm.style.display="flex"}if(el.endChatButton){el.endChatButton.style.display="none"}if(el.startChatButton){el.startChatButton.disabled=false}if(el.chatFooter){el.chatFooter.style.display="none"}if(el.chatInput){el.chatInput.value="";el.chatInput.disabled=true;el.chatInput.placeholder=GamblioChatWidget.hasToken()?"Click to start conversation":"Enter your name to start"}if(el.sendButton){el.sendButton.disabled=true}GamblioChatWidget.updateFilePreview(null);if(el.preChatContainer){el.preChatContainer.style.display="flex";const label=el.preChatContainer.querySelector("label");if(GamblioChatWidget.hasToken()){if(label){label.textContent="Click to start conversation"}if(el.preChatInput){el.preChatInput.value="";el.preChatInput.style.display="none"}if(el.preChatPlayerId){el.preChatPlayerId.value="";el.preChatPlayerId.style.display="none"}}else{if(label){label.textContent="Enter your name, ID or email (optional)"}if(el.preChatInput){el.preChatInput.value="";el.preChatInput.style.display=""}if(el.preChatPlayerId){el.preChatPlayerId.value="";el.preChatPlayerId.style.display=""}}}if(GamblioChatWidget.elements.emojiPicker){GamblioChatWidget.elements.emojiPicker.style.display="none"}GamblioChatWidget.playerId=null;GamblioChatWidget.resetRatingState();if(GamblioChatWidget.visibilityObserver){GamblioChatWidget.visibilityObserver.disconnect();GamblioChatWidget.visibilityObserver=null}if(GamblioChatWidget.visibilityTimeout){clearTimeout(GamblioChatWidget.visibilityTimeout);GamblioChatWidget.visibilityTimeout=null}GamblioChatWidget.visibleIdsSet.clear();GamblioChatWidget.seenIdsSet.clear();GamblioChatWidget.setChatAriaState(false);el.chatToggle?.classList.remove("active");el.chatContainer?.classList.remove("open")}static setupEventListeners(){const el=GamblioChatWidget.elements;el.chatToggle?.addEventListener("click",()=>GamblioChatWidget.toggleChat());el.chatClose?.addEventListener("click",()=>GamblioChatWidget.closeChat());el.chatContainer?.addEventListener("click",event=>event.stopPropagation());el.startChatButton?.addEventListener("click",()=>GamblioChatWidget.startChat());el.preChatInput?.addEventListener("keypress",event=>{if(event.key==="Enter"){event.preventDefault();GamblioChatWidget.startChat()}});el.preChatPlayerId?.addEventListener("keypress",event=>{if(event.key==="Enter"){event.preventDefault();GamblioChatWidget.startChat()}});el.endChatButton?.addEventListener("click",()=>GamblioChatWidget.handleEndChat());el.reopenChatButton?.addEventListener("click",()=>GamblioChatWidget.resetUi());el.sendButton?.addEventListener("click",()=>GamblioChatWidget.sendMessage());el.chatInput?.addEventListener("keydown",event=>{if(event.key==="Enter"){event.preventDefault();GamblioChatWidget.sendMessage()}});el.chatInput?.addEventListener("input",()=>GamblioChatWidget.clearTypingIndicator());el.fileInput?.addEventListener("change",event=>GamblioChatWidget.handleFileSelect(event));el.removeFile?.addEventListener("click",()=>GamblioChatWidget.removeSelectedFile());el.emojiButton?.addEventListener("click",event=>{event.stopPropagation();GamblioChatWidget.toggleEmojiPicker()});if(el.emojiPicker){el.emojiPicker.addEventListener("emoji-click",event=>{if(!GamblioChatWidget.elements.chatInput){return}GamblioChatWidget.elements.chatInput.value+=event.detail.unicode;GamblioChatWidget.elements.chatInput.focus();GamblioChatWidget.elements.emojiPicker.style.display="none"})}if(!GamblioChatWidget.documentClickHandler){GamblioChatWidget.documentClickHandler=event=>{const picker=GamblioChatWidget.elements.emojiPicker;const button=GamblioChatWidget.elements.emojiButton;if(!picker||picker.style.display==="none"){return}if(button&&button.contains(event.target)){return}if(picker.contains(event.target)){return}picker.style.display="none"};document.addEventListener("click",GamblioChatWidget.documentClickHandler)}const ratingContainer=el.ratingContainer;if(ratingContainer){const ratingButtons=Array.from(ratingContainer.querySelectorAll("[data-rating]"));ratingButtons.forEach(btn=>{btn.addEventListener("click",()=>GamblioChatWidget.handleRatingSelection(Number(btn.dataset.rating)));btn.addEventListener("mouseenter",()=>{if(!GamblioChatWidget.hasSubmittedRating){GamblioChatWidget.updateRatingStars(Number(btn.dataset.rating))}});btn.addEventListener("mouseleave",()=>{if(!GamblioChatWidget.hasSubmittedRating){GamblioChatWidget.updateRatingStars()}});btn.addEventListener("keydown",event=>{if(event.key==="Enter"||event.key===" "){event.preventDefault();GamblioChatWidget.handleRatingSelection(Number(btn.dataset.rating))}if(event.key==="ArrowRight"||event.key==="ArrowUp"){event.preventDefault();GamblioChatWidget.focusAdjacentRatingButton(btn,1)}if(event.key==="ArrowLeft"||event.key==="ArrowDown"){event.preventDefault();GamblioChatWidget.focusAdjacentRatingButton(btn,-1)}})});ratingContainer.addEventListener("mouseleave",()=>{if(!GamblioChatWidget.hasSubmittedRating){GamblioChatWidget.updateRatingStars()}})}el.ratingSubmitButton?.addEventListener("click",()=>GamblioChatWidget.handleRatingSubmit());el.ratingSkipButton?.addEventListener("click",()=>GamblioChatWidget.handleRatingSkip())}static ensureEmojiPicker(){if(typeof customElements==="undefined"){return}if(customElements.get("emoji-picker")){return}if(document.getElementById("gamblio-emoji-picker-module")){return}const script=document.createElement("script");script.id="gamblio-emoji-picker-module";script.type="module";script.src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js";document.head.appendChild(script)}static ensureMarkdownConverter(){if(GamblioChatWidget.markdownConverter){return}if(typeof showdown==="undefined"){if(document.getElementById("gamblio-showdown-script")){return}const script=document.createElement("script");script.id="gamblio-showdown-script";script.src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js";script.onload=()=>{GamblioChatWidget.markdownConverter=new showdown.Converter({openLinksInNewWindow:true})};document.head.appendChild(script)}else{GamblioChatWidget.markdownConverter=new showdown.Converter({openLinksInNewWindow:true})}}static hasToken(){return Boolean(GamblioChatWidget.token)}static toggleChat(){const el=GamblioChatWidget.elements;if(el.chatContainer?.classList.contains("open")){GamblioChatWidget.closeChat()}else{GamblioChatWidget.openChat()}}static openChat(){const el=GamblioChatWidget.elements;if(!el.chatContainer){return}el.chatContainer.classList.add("open");el.chatToggle?.classList.add("active");GamblioChatWidget.setChatAriaState(true);GamblioChatWidget.ensureEmojiPicker();if(GamblioChatWidget.hasToken()&&!GamblioChatWidget.socket){GamblioChatWidget.startChat(true)}setTimeout(()=>{GamblioChatWidget.shouldAutoScroll=true;GamblioChatWidget.renderMessages();GamblioChatWidget.setupMessageVisibilityObserver();GamblioChatWidget.shouldAutoScroll=false;el.chatInput?.focus()},250)}static closeChat(){const el=GamblioChatWidget.elements;if(!el.chatContainer){return}el.chatContainer.classList.remove("open");el.chatToggle?.classList.remove("active");GamblioChatWidget.setChatAriaState(false);if(GamblioChatWidget.visibilityObserver){GamblioChatWidget.visibilityObserver.disconnect();GamblioChatWidget.visibilityObserver=null}}static setChatAriaState(open){const el=GamblioChatWidget.elements;el.chatToggle?.setAttribute("aria-expanded",open?"true":"false");el.chatContainer?.setAttribute("aria-hidden",open?"false":"true")}static startChat(auto=false){if(GamblioChatWidget.socket&&GamblioChatWidget.socket.readyState===WebSocket.OPEN){return}if(!GamblioChatWidget.hasToken()){const value=(GamblioChatWidget.elements.preChatInput?.value||"").trim();if(!value&&auto){return}GamblioChatWidget.playerName=value||GamblioChatWidget.generateGuestName();const playerIdValue=(GamblioChatWidget.elements.preChatPlayerId?.value||"").trim();GamblioChatWidget.playerId=playerIdValue?parseInt(playerIdValue,10):null}if(GamblioChatWidget.elements.startChatButton){GamblioChatWidget.elements.startChatButton.disabled=true}if(GamblioChatWidget.elements.preChatContainer){GamblioChatWidget.elements.preChatContainer.style.display="none"}if(GamblioChatWidget.elements.chatFooter){GamblioChatWidget.elements.chatFooter.style.display="flex"}GamblioChatWidget.messages=[];GamblioChatWidget.renderMessages();GamblioChatWidget.setChatInputEnabled(false,"Connecting...");GamblioChatWidget.createWebSocket()}static createWebSocket(){const url=GamblioChatWidget.resolveWebSocketUrl();if(!url){console.warn("[Gamblio][Chat] Missing CONFIG.wsUrl for chat");GamblioChatWidget.setChatInputEnabled(false,"Connection unavailable");return}GamblioChatWidget.destroySocket();try{const socket=new WebSocket(url);GamblioChatWidget.socket=socket;socket.addEventListener("open",()=>{const payload={tag:"playerStartChatAndJoin",playerToken:GamblioChatWidget.token||null,clientId:GamblioChatWidget.clientId??null,playerName:GamblioChatWidget.playerName||""};if(GamblioChatWidget.playerId){payload.customPlayerId=GamblioChatWidget.playerId}GamblioChatWidget.sendSocketMessage(payload)});socket.addEventListener("message",event=>GamblioChatWidget.handleSocketMessage(event));socket.addEventListener("error",event=>{console.warn("[Gamblio][Chat] WebSocket error",event)});socket.addEventListener("close",()=>{GamblioChatWidget.socket=null;GamblioChatWidget.setChatInputEnabled(false,"Connection lost")})}catch(error){console.error("[Gamblio][Chat] Unable to open WebSocket",error);GamblioChatWidget.setChatInputEnabled(false,"Connection error")}}static resolveWebSocketUrl(){if(CONFIG.wsUrl){const trimmed=CONFIG.wsUrl.replace(/\/$/,"");return trimmed.endsWith("/ws/chat")?trimmed:`${trimmed}/ws/chat`}if(CONFIG.apiUrl){try{const base=new URL(CONFIG.apiUrl);base.protocol=base.protocol==="https:"?"wss:":"ws:";return`${base.origin}/ws/chat`}catch(error){console.warn("[Gamblio][Chat] Invalid CONFIG.apiUrl",error)}}return null}static sendSocketMessage(payload){if(!GamblioChatWidget.socket||GamblioChatWidget.socket.readyState!==WebSocket.OPEN){console.warn("[Gamblio][Chat] Tried to send message while socket not open");return}GamblioChatWidget.socket.send(JSON.stringify(payload))}static handleSocketMessage(event){let data;try{data=JSON.parse(event.data)}catch(error){console.warn("[Gamblio][Chat] Failed to parse message",error);return}if(data.tag==="bump"){GamblioChatWidget.handleBumpMessage(data);return}if(data.tag==="existingMessages"){GamblioChatWidget.handleExistingMessages(data);return}console.info("[Gamblio][Chat] Unhandled message",data)}static handleBumpMessage(payload){const data=payload.bump_data||{};switch(payload.bump_type){case"startChatSuccess":GamblioChatWidget.chatId=data.chat??data.chatId??null;GamblioChatWidget.handleChatReady();break;case"messageDelivered":GamblioChatWidget.messages.forEach(msg=>{if(msg.id===data.messageId){msg.delivered_at=data.delivered_at}});GamblioChatWidget.renderMessages();break;case"messageSeen":case"messageRead":const messageId=data.messageId;GamblioChatWidget.messages.forEach(msg=>{if(msg.id===messageId){msg.seen_by=data.seen_by||msg.seen_by||[]}});GamblioChatWidget.renderMessages();break;case"messagesMarkedAsRead":const messageIds=data.messageIds||[];const messageIdsNumbers=messageIds.map(id=>Number(id));GamblioChatWidget.messages.forEach(msg=>{const msgId=Number(msg.id);if(messageIdsNumbers.includes(msgId)){const seenAt=Math.floor(Date.now()/1e3);if(!msg.seen_by||!Array.isArray(msg.seen_by)||msg.seen_by.length===0){msg.seen_by=[{seen_at:seenAt}]}else{const hasCurrentSeen=msg.seen_by.some(entry=>entry.seen_at===seenAt);if(!hasCurrentSeen){msg.seen_by.push({seen_at:seenAt})}}}});GamblioChatWidget.renderMessages();break;case"newMessage":GamblioChatWidget.clearTypingIndicator();if(data.is_sent_safely===true){break}GamblioChatWidget.pushMessage({id:data.id||data.messageId,role:data.role,content:data.text,attachment:data.attachment_url,unix:Number(data.timestamp)||Math.floor(Date.now()/1e3),delivered_at:data.delivered_at!==undefined?data.delivered_at:null,seen_by:data.seen_by||null});GamblioChatWidget.renderMessages();GamblioChatWidget.setupMessageVisibilityObserver();break;case"switchedStatusToClosed":GamblioChatWidget.handleChatClosed();break;default:console.info("[Gamblio][Chat] Unknown bump type",payload)}}static handleExistingMessages(payload){const incoming=Array.isArray(payload.messages)?payload.messages:[];GamblioChatWidget.messages=incoming.filter(msg=>msg&&msg.role!=="system_event"&&msg.role!=="system_chat_rating"&&msg.is_sent_safely!==true).map(msg=>({id:msg.id||msg.messageId,role:msg.role,content:msg.content,attachment:msg.attachment_url,unix:Number(msg.timestamp)||Math.floor(Date.now()/1e3),delivered_at:msg.delivered_at!==undefined?msg.delivered_at:null,seen_by:msg.seen_by||null}));if(payload.chat_id){GamblioChatWidget.chatId=payload.chat_id;GamblioChatWidget.handleChatReady()}GamblioChatWidget.renderMessages();GamblioChatWidget.setupMessageVisibilityObserver()}static handleChatReady(){GamblioChatWidget.setChatInputEnabled(true,"Type your message...");GamblioChatWidget.elements.endChatButton?.style.setProperty("display","block");if(GamblioChatWidget.elements.startChatButton){GamblioChatWidget.elements.startChatButton.disabled=false}GamblioChatWidget.elements.chatInput?.focus()}static handleChatClosed(){GamblioChatWidget.clearTypingIndicator();GamblioChatWidget.setChatInputEnabled(false,"Chat closed");GamblioChatWidget.elements.messageForm?.style.setProperty("display","none");GamblioChatWidget.elements.chatClosedMessage?.style.setProperty("display","block");GamblioChatWidget.elements.endChatButton?.style.setProperty("display","none");if(GamblioChatWidget.elements.startChatButton){GamblioChatWidget.elements.startChatButton.disabled=false}GamblioChatWidget.removeSelectedFile();GamblioChatWidget.chatId=null;GamblioChatWidget.destroySocket();if(!GamblioChatWidget.hasSubmittedRating){GamblioChatWidget.showRatingPrompt()}}static pushMessage(message){if(!message){return}GamblioChatWidget.messages.push({id:message.id||null,role:message.role||"bot",content:message.content||"",attachment:message.attachment||null,unix:message.unix||Math.floor(Date.now()/1e3),delivered_at:message.delivered_at!==undefined?message.delivered_at:null,seen_by:message.seen_by||null});GamblioChatWidget.renderMessages()}static renderMessages(){const el=GamblioChatWidget.elements;if(!el.messagesContainer){return}const scrollContainer=el.chatBody||el.messagesContainer;const atBottom=Math.abs(scrollContainer.scrollHeight-scrollContainer.scrollTop-scrollContainer.clientHeight)<=5;el.messagesContainer.innerHTML="";let lastSeparatorKey=null;GamblioChatWidget.messages.forEach(msg=>{if(!msg.unix){if(msg.timestamp){msg.unix=Number(msg.timestamp)}else{msg.unix=Math.floor(Date.now()/1e3)}}const d=new Date(msg.unix*1e3);const separatorKey=`${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;if(lastSeparatorKey!==separatorKey){lastSeparatorKey=separatorKey;el.messagesContainer.appendChild(GamblioChatWidget.buildDateSeparator(msg.unix))}el.messagesContainer.appendChild(GamblioChatWidget.buildMessageElement(msg))});if(GamblioChatWidget.shouldAutoScroll||atBottom){scrollContainer.scrollTop=scrollContainer.scrollHeight}}static buildDateSeparator(unixSeconds){const wrapper=document.createElement("div");wrapper.className="nx-date-separator";const lineLeft=document.createElement("div");lineLeft.className="nx-separator-line";const label=document.createElement("span");label.className="nx-date-separator-label";label.textContent=GamblioChatWidget.separatorLabel(unixSeconds);const lineRight=document.createElement("div");lineRight.className="nx-separator-line";wrapper.append(lineLeft,label,lineRight);return wrapper}static buildMessageElement(message){const wrapper=document.createElement("div");wrapper.className=`message-wrapper ${message.role==="player"?"user":"bot"}`;if(GamblioChatWidget.isBotMessage(message.role)&&message.id){wrapper.setAttribute("data-message-id",message.id)}const bubble=document.createElement("div");bubble.className=`message ${message.role==="player"?"user":"bot"}`;let text=message.content||"";let html="";if(message.role==="player"){html=GamblioChatWidget.escapeHtml(text).replace(/\n/g,"<br>")}else{GamblioChatWidget.ensureMarkdownConverter();try{if(GamblioChatWidget.markdownConverter){html=GamblioChatWidget.markdownConverter.makeHtml(text)}else{html=GamblioChatWidget.escapeHtml(text).replace(/\n/g,"<br>")}}catch(e){html=GamblioChatWidget.escapeHtml(text).replace(/\n/g,"<br>")}}bubble.innerHTML=html;if(message.attachment){const img=document.createElement("img");img.src=message.attachment;img.alt="Message attachment";img.style.cssText="max-width: 200px; max-height: 200px; width: 100%; height: auto; border-radius: 8px; margin-top: 8px; cursor: pointer; object-fit: cover;";img.addEventListener("click",()=>window.open(message.attachment,"_blank"));bubble.appendChild(img)}const timestamp=document.createElement("span");timestamp.className="timestamp";const isToday=GamblioChatWidget.isTodayUnix(message.unix);timestamp.textContent=GamblioChatWidget.formatMessageTimestamp(message.unix);timestamp.title=GamblioChatWidget.formatMessageTimestampTitle(message.unix,isToday);if(message.role==="player"){const messageWithIndicator=document.createElement("div");messageWithIndicator.classList.add("message-with-indicator");const deliveryIndicator=document.createElement("div");deliveryIndicator.classList.add("delivery-indicator");const checkmarkIcon=document.createElement("span");checkmarkIcon.classList.add("checkmark-icon");const hasSeenBy=GamblioChatWidget.isMessageSeen(message);const isDelivered=GamblioChatWidget.isMessageDelivered(message);if(isDelivered){checkmarkIcon.innerHTML="✓✓";if(hasSeenBy){checkmarkIcon.classList.add("delivered");checkmarkIcon.classList.remove("sent");const seenEntry=message.seen_by[0];if(seenEntry&&seenEntry.seen_at){checkmarkIcon.title=`Seen at ${GamblioChatWidget.formatSeenTime(seenEntry.seen_at)}`}else{checkmarkIcon.title="Seen"}}else{checkmarkIcon.classList.add("sent");checkmarkIcon.classList.remove("delivered");checkmarkIcon.title=`Delivered at ${GamblioChatWidget.formatDeliveredTime(message.delivered_at)}`}}else{checkmarkIcon.innerHTML="✓";checkmarkIcon.classList.add("sent");checkmarkIcon.classList.remove("delivered");checkmarkIcon.title="Sent"}deliveryIndicator.appendChild(checkmarkIcon);messageWithIndicator.appendChild(bubble);messageWithIndicator.appendChild(deliveryIndicator);wrapper.appendChild(messageWithIndicator);wrapper.appendChild(timestamp)}else{wrapper.appendChild(timestamp);wrapper.appendChild(bubble)}return wrapper}static formatMessageTimestamp(unixSeconds){const now=new Date;const msgDate=new Date(unixSeconds*1e3);const isToday=GamblioChatWidget.isTodayUnix(unixSeconds);if(isToday){return GamblioChatWidget.timeHHmmss(unixSeconds)}else{const diffDays=GamblioChatWidget.diffDaysFromToday(unixSeconds);return diffDays===1?"1 day ago":`${diffDays} days ago`}}static formatMessageTimestampTitle(unixSeconds,isToday){const msgDate=new Date(unixSeconds*1e3);if(isToday){return msgDate.toLocaleString(undefined,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:false})}else{return GamblioChatWidget.timeHHmmss(unixSeconds)}}static timeHHmmss(unixSeconds){const d=new Date(unixSeconds*1e3);return d.toLocaleTimeString("en-GB",{hour12:false,hour:"2-digit",minute:"2-digit",second:"2-digit"})}static isTodayUnix(unixSeconds){if(!unixSeconds)return false;const d=new Date(unixSeconds*1e3);const now=new Date;return d.getFullYear()===now.getFullYear()&&d.getMonth()===now.getMonth()&&d.getDate()===now.getDate()}static diffDaysFromToday(unixSeconds){const d=new Date(unixSeconds*1e3);const now=new Date;const startOfToday=new Date(now.getFullYear(),now.getMonth(),now.getDate()).getTime();const startOfThat=new Date(d.getFullYear(),d.getMonth(),d.getDate()).getTime();return Math.floor((startOfToday-startOfThat)/(1e3*60*60*24))}static separatorLabel(unixSeconds){const diff=GamblioChatWidget.diffDaysFromToday(unixSeconds);if(diff===0)return"Today";if(diff===1)return"Yesterday";const d=new Date(unixSeconds*1e3);return d.toLocaleDateString(undefined,{month:"short",day:"2-digit",year:"numeric"})}static isBotMessage(role){return role==="system_human"||role==="system_ai_wasco"||role==="system_ai_vector"}static isMessageDelivered(message){return message.delivered_at!==null&&message.delivered_at!==undefined}static isMessageSeen(message){return message.seen_by&&Array.isArray(message.seen_by)&&message.seen_by.length>0}static formatSeenTime(seenAt){const seenTimestamp=typeof seenAt==="string"?parseInt(seenAt,10):seenAt;const seenDate=new Date(seenTimestamp*1e3);return seenDate.toLocaleString(undefined,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:false})}static formatDeliveredTime(deliveredAt){const deliveredTimestamp=typeof deliveredAt==="string"?parseInt(deliveredAt,10):deliveredAt;const deliveryDate=new Date(deliveredTimestamp*1e3);return deliveryDate.toLocaleString(undefined,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:false})}static escapeHtml(value){return(value||"").replace(/[&<>"']/g,char=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[char]))}static sendMessage(){if(!GamblioChatWidget.socket||GamblioChatWidget.socket.readyState!==WebSocket.OPEN){console.warn("[Gamblio][Chat] Cannot send message while socket is closed");return}if(!GamblioChatWidget.chatId){console.warn("[Gamblio][Chat] Cannot send message without chatId");return}const text=(GamblioChatWidget.elements.chatInput?.value||"").trim();if(!text&&!GamblioChatWidget.selectedFile){return}if(GamblioChatWidget.isSending){return}GamblioChatWidget.isSending=true;GamblioChatWidget.setChatInputEnabled(false);const finalize=()=>{GamblioChatWidget.finishSending();GamblioChatWidget.scheduleTypingIndicator()};if(GamblioChatWidget.selectedFile){const reader=new FileReader;reader.onload=()=>{GamblioChatWidget.sendSocketMessage({tag:"playerSendMessage",chatId:GamblioChatWidget.chatId,message:text||"Image attachment",attachment:reader.result});if(GamblioChatWidget.elements.chatInput){GamblioChatWidget.elements.chatInput.value=""}GamblioChatWidget.removeSelectedFile();finalize()};reader.onerror=()=>{console.warn("[Gamblio][Chat] Failed to read attachment");GamblioChatWidget.removeSelectedFile();finalize()};reader.readAsDataURL(GamblioChatWidget.selectedFile)}else{GamblioChatWidget.sendSocketMessage({tag:"playerSendMessage",chatId:GamblioChatWidget.chatId,message:text,attachment:null});if(GamblioChatWidget.elements.chatInput){GamblioChatWidget.elements.chatInput.value=""}finalize()}}static finishSending(){GamblioChatWidget.isSending=false;if(GamblioChatWidget.chatId){GamblioChatWidget.setChatInputEnabled(true,"Type your message...");GamblioChatWidget.elements.chatInput?.focus()}}static handleFileSelect(event){const file=event.target.files&&event.target.files[0];if(!file){return}if(!file.type.startsWith("image/")){window.alert("Please select an image file");event.target.value="";return}if(file.size>5*1024*1024){window.alert("File size must be less than 5MB");event.target.value="";return}GamblioChatWidget.selectedFile=file;GamblioChatWidget.updateFilePreview(file)}static updateFilePreview(file){const el=GamblioChatWidget.elements;if(!el.filePreview){return}if(GamblioChatWidget.previewObjectUrl){URL.revokeObjectURL(GamblioChatWidget.previewObjectUrl);GamblioChatWidget.previewObjectUrl=null}if(!file){el.filePreview.style.display="none";if(el.previewImage){el.previewImage.src=""}return}const url=URL.createObjectURL(file);GamblioChatWidget.previewObjectUrl=url;el.filePreview.style.display="flex";if(el.previewImage){el.previewImage.src=url}}static removeSelectedFile(){GamblioChatWidget.selectedFile=null;if(GamblioChatWidget.elements.fileInput){GamblioChatWidget.elements.fileInput.value=""}GamblioChatWidget.updateFilePreview(null)}static scheduleTypingIndicator(){GamblioChatWidget.clearTypingIndicator();GamblioChatWidget.typingTimeoutId=window.setTimeout(()=>{GamblioChatWidget.setTypingIndicator(true)},4e3+Math.floor(Math.random()*3e3))}static clearTypingIndicator(){if(GamblioChatWidget.typingTimeoutId){window.clearTimeout(GamblioChatWidget.typingTimeoutId);GamblioChatWidget.typingTimeoutId=null}GamblioChatWidget.setTypingIndicator(false)}static setTypingIndicator(visible){const bubble=GamblioChatWidget.elements.typingBubble;if(!bubble){return}bubble.style.display=visible?"flex":"none"}static setChatInputEnabled(enabled,placeholder){const el=GamblioChatWidget.elements;if(el.chatInput){el.chatInput.disabled=!enabled;if(placeholder!==undefined){el.chatInput.placeholder=placeholder}}if(el.sendButton){el.sendButton.disabled=!enabled}}static sendCloseMessage(){if(!GamblioChatWidget.chatId){return}const payload={tag:"playerLeaveChatAndClose",playerToken:GamblioChatWidget.token||null,chatId:GamblioChatWidget.chatId,clientId:GamblioChatWidget.clientId??null,playerName:GamblioChatWidget.playerName||""};if(GamblioChatWidget.playerId){payload.customPlayerId=GamblioChatWidget.playerId}GamblioChatWidget.sendSocketMessage(payload);GamblioChatWidget.chatId=null}static handleEndChat(){GamblioChatWidget.sendCloseMessage();GamblioChatWidget.handleChatClosed()}static handleBeforeUnload(){GamblioChatWidget.sendCloseMessage();GamblioChatWidget.destroySocket()}static destroySocket(){if(GamblioChatWidget.socket){try{GamblioChatWidget.socket.close()}catch(error){console.warn("[Gamblio][Chat] Failed to close socket",error)}GamblioChatWidget.socket=null}}static generateGuestName(){const letters="ABCDEFGHIJKLMNOPQRSTUVWXYZ";let suffix="";for(let i=0;i<4;i++){suffix+=letters.charAt(Math.floor(Math.random()*letters.length))}return`GUEST_${suffix}`}static dayKey(unixSeconds){const date=new Date(unixSeconds*1e3);return`${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()}`}static toggleEmojiPicker(){const picker=GamblioChatWidget.elements.emojiPicker;if(!picker){return}GamblioChatWidget.ensureEmojiPicker();picker.style.display=picker.style.display==="none"?"block":"none"}static handleRatingSelection(value){const ratingContainer=GamblioChatWidget.elements.ratingContainer;if(!ratingContainer||GamblioChatWidget.hasSubmittedRating)return;GamblioChatWidget.selectedRatingValue=value;GamblioChatWidget.updateRatingStars();if(GamblioChatWidget.elements.ratingSubmitButton){GamblioChatWidget.elements.ratingSubmitButton.disabled=GamblioChatWidget.selectedRatingValue===0}}static updateRatingStars(hoverValue=null){const ratingContainer=GamblioChatWidget.elements.ratingContainer;if(!ratingContainer)return;const ratingButtons=Array.from(ratingContainer.querySelectorAll("[data-rating]"));const valueToUse=hoverValue!==null?hoverValue:GamblioChatWidget.selectedRatingValue;ratingButtons.forEach(btn=>{const isActive=Number(btn.dataset.rating)<=valueToUse;btn.classList.toggle("is-active",isActive);btn.setAttribute("aria-pressed",String(isActive))})}static focusAdjacentRatingButton(currentButton,direction){const ratingContainer=GamblioChatWidget.elements.ratingContainer;if(!ratingContainer)return;const ratingButtons=Array.from(ratingContainer.querySelectorAll("[data-rating]"));const currentIndex=ratingButtons.indexOf(currentButton);const nextIndex=(currentIndex+direction+ratingButtons.length)%ratingButtons.length;ratingButtons[nextIndex].focus()}static handleRatingSubmit(){if(!GamblioChatWidget.socket||GamblioChatWidget.socket.readyState!==WebSocket.OPEN||!GamblioChatWidget.chatId){console.warn("[Gamblio][Chat] Unable to submit rating; socket not open or chat missing.");return}if(GamblioChatWidget.selectedRatingValue===0)return;const payload={tag:"playerNewChatRating",chatId:GamblioChatWidget.chatId,clientId:GamblioChatWidget.clientId??null,rating:GamblioChatWidget.selectedRatingValue};if(GamblioChatWidget.token){payload.playerToken=GamblioChatWidget.token}if(GamblioChatWidget.playerId){payload.customPlayerId=GamblioChatWidget.playerId}try{GamblioChatWidget.sendSocketMessage(payload);GamblioChatWidget.hasSubmittedRating=true;if(GamblioChatWidget.elements.ratingSubmitButton){GamblioChatWidget.elements.ratingSubmitButton.disabled=true}const ratingContainer=GamblioChatWidget.elements.ratingContainer;if(ratingContainer){const ratingButtons=Array.from(ratingContainer.querySelectorAll("[data-rating]"));ratingButtons.forEach(btn=>btn.disabled=true)}if(GamblioChatWidget.elements.ratingSkipButton){GamblioChatWidget.elements.ratingSkipButton.classList.add("hidden")}if(GamblioChatWidget.elements.ratingThanksMessage){GamblioChatWidget.elements.ratingThanksMessage.classList.remove("hidden")}setTimeout(()=>{if(ratingContainer){ratingContainer.classList.add("hidden")}},5e3)}catch(error){console.error("[Gamblio][Chat] Failed to send rating:",error)}}static handleRatingSkip(){GamblioChatWidget.hasSubmittedRating=false;GamblioChatWidget.hideRatingPrompt()}static showRatingPrompt(){const ratingContainer=GamblioChatWidget.elements.ratingContainer;if(!ratingContainer)return;ratingContainer.classList.remove("hidden");if(GamblioChatWidget.elements.ratingThanksMessage){GamblioChatWidget.elements.ratingThanksMessage.classList.add("hidden")}if(GamblioChatWidget.elements.ratingSkipButton){GamblioChatWidget.elements.ratingSkipButton.classList.remove("hidden")}const ratingButtons=Array.from(ratingContainer.querySelectorAll("[data-rating]"));ratingButtons.forEach(btn=>btn.disabled=false)}static hideRatingPrompt(){const ratingContainer=GamblioChatWidget.elements.ratingContainer;if(!ratingContainer)return;ratingContainer.classList.add("hidden")}static resetRatingState(){GamblioChatWidget.selectedRatingValue=0;GamblioChatWidget.hasSubmittedRating=false;GamblioChatWidget.hideRatingPrompt();GamblioChatWidget.updateRatingStars();if(GamblioChatWidget.elements.ratingSubmitButton){GamblioChatWidget.elements.ratingSubmitButton.disabled=true}if(GamblioChatWidget.elements.ratingThanksMessage){GamblioChatWidget.elements.ratingThanksMessage.classList.add("hidden")}if(GamblioChatWidget.elements.ratingSkipButton){GamblioChatWidget.elements.ratingSkipButton.classList.remove("hidden")}const ratingContainer=GamblioChatWidget.elements.ratingContainer;if(ratingContainer){const ratingButtons=Array.from(ratingContainer.querySelectorAll("[data-rating]"));ratingButtons.forEach(btn=>{btn.disabled=false;btn.setAttribute("aria-pressed","false")})}}static isMessageAlreadySeen(messageId){if(GamblioChatWidget.seenIdsSet.has(messageId)){return true}const message=GamblioChatWidget.messages.find(msg=>msg.id===messageId);if(message){if(message.seen_by&&Array.isArray(message.seen_by)&&message.seen_by.length>0){const hasPlayerSeen=message.seen_by.some(entry=>entry.seen_by_type==="player"||entry.user_id===null);if(hasPlayerSeen){return true}}}return false}static sendMessagesAsRead(messageIds){if(!GamblioChatWidget.chatId){console.warn("[Visibility] ✗ SEND FAILED - No chatId");return}if(!GamblioChatWidget.socket){console.warn("[Visibility] ✗ SEND FAILED - No socket");return}if(GamblioChatWidget.socket.readyState!==WebSocket.OPEN){console.warn("[Visibility] ✗ SEND FAILED - Socket not OPEN, state:",GamblioChatWidget.socket.readyState);return}if(messageIds.length===0){console.warn("[Visibility] ✗ SEND FAILED - Empty messageIds array");return}const payload={tag:"playerMarkMessagesAsRead",chatId:GamblioChatWidget.chatId,messageIds:messageIds};try{GamblioChatWidget.sendSocketMessage(payload)}catch(error){console.error("[Visibility] ✗ SEND FAILED - Exception:",error)}}static setupMessageVisibilityObserver(){if(!GamblioChatWidget.chatId||!GamblioChatWidget.elements.chatContainer?.classList.contains("open")){return}const scrollContainer=document.querySelector(".nx-chat-body");if(!scrollContainer){return}if(GamblioChatWidget.visibilityObserver){GamblioChatWidget.visibilityObserver.disconnect()}if(GamblioChatWidget.visibilityTimeout){clearTimeout(GamblioChatWidget.visibilityTimeout)}GamblioChatWidget.visibilityObserver=new IntersectionObserver(entries=>{entries.forEach(entry=>{const messageId=Number(entry.target.getAttribute("data-message-id"));if(!messageId){return}if(entry.isIntersecting&&entry.intersectionRatio>.01){GamblioChatWidget.visibleIdsSet.add(messageId)}else{GamblioChatWidget.visibleIdsSet.delete(messageId)}});if(GamblioChatWidget.visibilityTimeout){clearTimeout(GamblioChatWidget.visibilityTimeout)}GamblioChatWidget.visibilityTimeout=setTimeout(()=>{if(GamblioChatWidget.visibleIdsSet.size>0){const unseenIds=Array.from(GamblioChatWidget.visibleIdsSet).filter(id=>!GamblioChatWidget.isMessageAlreadySeen(id));if(unseenIds.length>0){GamblioChatWidget.sendMessagesAsRead(unseenIds);unseenIds.forEach(id=>GamblioChatWidget.seenIdsSet.add(id))}GamblioChatWidget.visibleIdsSet.clear()}},300)},{root:scrollContainer,rootMargin:"-50px",threshold:[0,.01,.5,1]});const elements=document.querySelectorAll("[data-message-id]");elements.forEach(el=>{GamblioChatWidget.visibilityObserver.observe(el)});setTimeout(()=>{const visibleElements=Array.from(elements).filter(el=>{const rect=el.getBoundingClientRect();const containerRect=scrollContainer.getBoundingClientRect();return rect.top<containerRect.bottom&&rect.bottom>containerRect.top&&rect.left<containerRect.right&&rect.right>containerRect.left});if(visibleElements.length>0){visibleElements.forEach(el=>{const messageId=Number(el.getAttribute("data-message-id"));if(messageId&&!GamblioChatWidget.isMessageAlreadySeen(messageId)){GamblioChatWidget.visibleIdsSet.add(messageId)}});if(GamblioChatWidget.visibilityTimeout){clearTimeout(GamblioChatWidget.visibilityTimeout)}GamblioChatWidget.visibilityTimeout=setTimeout(()=>{if(GamblioChatWidget.visibleIdsSet.size>0){const unseenIds=Array.from(GamblioChatWidget.visibleIdsSet).filter(id=>!GamblioChatWidget.isMessageAlreadySeen(id));if(unseenIds.length>0){GamblioChatWidget.sendMessagesAsRead(unseenIds);unseenIds.forEach(id=>GamblioChatWidget.seenIdsSet.add(id))}GamblioChatWidget.visibleIdsSet.clear()}},300)}},100)}}class Gamblio{static token=undefined;static language="en";static isVip=false;static chatConfig={};static recommendationConfig={};static async init(props){const tokenName=props.tokenName;const language=props.language;const config=props.recommendationConfig||{};const chatConfig=props.chatConfig||{};const gamePlayUrl=props.gamePlayUrl;Gamblio.recommendationConfig={backgroundType:config.backgroundType||"transparent",gradientDirection:config.gradientDirection||"to right",gradientColors:config.gradientColors||["rgba(3, 132, 145,1)","rgba(0, 0, 0, 1)"],videoIndex:config.videoIndex||1,imageIndex:config.imageIndex||1,imageExtension:config.imageExtension||"jpg",shadowColor:config.shadowColor||"rgba(213, 208, 208)",navButtonColor:config.navButtonColor||"#f5f5f5",navButtonHoverColor:config.navButtonHoverColor||"#ffffff",displayMode:config.displayMode||"carousel"};Gamblio.chatConfig={backgroundPrimary:chatConfig.backgroundPrimary||"#0292a0",hoverColor:chatConfig.hoverColor||"#0292a0",logoUrl:chatConfig.logoUrl||"https://app.gamblio.ai/logo-dark.svg"};Gamblio.backgroundType=Gamblio.recommendationConfig.backgroundType;Gamblio.shadowColor=Gamblio.recommendationConfig.shadowColor;Gamblio.gradientColors=Gamblio.recommendationConfig.gradientColors;Gamblio.gradientDirection=Gamblio.recommendationConfig.gradientDirection;Gamblio.videoIndex=Gamblio.recommendationConfig.videoIndex;Gamblio.imageIndex=Gamblio.recommendationConfig.imageIndex;Gamblio.imageExtension=Gamblio.recommendationConfig.imageExtension;Gamblio.navButtonColor=Gamblio.recommendationConfig.navButtonColor;Gamblio.navButtonHoverColor=Gamblio.recommendationConfig.navButtonHoverColor;Gamblio.displayMode=Gamblio.recommendationConfig.displayMode;Gamblio.backgroundPrimary=Gamblio.chatConfig.backgroundPrimary;Gamblio.logoUrl=Gamblio.chatConfig.logoUrl;Gamblio.hoverColor=Gamblio.chatConfig.hoverColor;Gamblio.clientId=props.clientId;Gamblio.gamePlayUrl=gamePlayUrl||"#";Gamblio.recommendationWidgetTargetContainerId=props.recommendationWidgetTargetContainerId;console.log(Gamblio.isVip,"IS VIP IP IPIPIP");if(language){Gamblio.language=language}const resolvedToken=Gamblio.resolveToken(tokenName);if(resolvedToken){Gamblio.token=resolvedToken;Gamblio.isVip=await Gamblio.determineVipStatus(resolvedToken);Gamblio.addChatWidget();Gamblio.addRecommendationWidget();return}Gamblio.addChatWidget()}static getCookie(name){const value=`; ${document.cookie}`;const parts=value.split(`; ${name}=`);if(parts.length===2)return parts.pop().split(";").shift()}static getTokenFromLocalStorage(name){if(!name||typeof window==="undefined")return undefined;try{return window.localStorage?.getItem(name)||undefined}catch(err){console.warn(`[Gamblio] Unable to read token "${name}" from localStorage.`,err);return undefined}}static resolveToken(tokenName){if(!tokenName){return undefined}const normalizedTokenName=typeof tokenName==="string"?tokenName.trim():undefined;let token;if(normalizedTokenName){token=Gamblio.getTokenFromLocalStorage(normalizedTokenName);if(token){return token}token=Gamblio.getCookie(normalizedTokenName);if(token){return token}}return undefined}static async determineVipStatus(token){if(!token)return false;try{const response=await fetch(`${CONFIG.apiUrl}/api/accounts/is_vip_player?token=${token}`);if(!response.ok){console.warn("[Gamblio] Failed to check VIP status. Falling back to non-VIP.");return false}const data=await response.json();if(typeof data==="boolean"){return data}if(typeof data?.isVip==="boolean"){return data.isVip}if(typeof data?.is_vip==="boolean"){return data.is_vip}}catch(err){console.warn("[Gamblio] Error while checking VIP status.",err)}return false}static addChatWidget(){GamblioChatWidget.init()}static addRecommendationWidget(){GamblioRecommendationWidget.init()}}

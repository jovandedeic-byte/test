const CONFIG={apiUrl:"http://dev-core.gamblio.ai:8001",wsUrl:"ws://dev-core.gamblio.ai:8001",recommendationWidgetGameUrlPrefixDemo:"https://your-casino.com/games/demo/",recommendationWidgetGameUrlPrefixPlay:"https://your-casino.com/games/play/"};class Gamblio{static token=undefined;static language="en";static isVip=false;static recommendationConfig={};static async init(props){const tokenName=props.tokenName;const language=props.language;const config=props.recommendationConfig||{};Gamblio.recommendationConfig={backgroundType:config.backgroundType||"transparent",gradientDirection:config.gradientDirection||"to right",gradientColors:config.gradientColors||["rgba(3, 132, 145,1)","rgba(0, 0, 0, 1)"],videoIndex:config.videoIndex||1,imageIndex:config.imageIndex||1,imageExtension:config.imageExtension||"jpg",shadowColor:config.shadowColor||"rgba(213, 208, 208)",navButtonColor:config.navButtonColor||"#f5f5f5",navButtonHoverColor:config.navButtonHoverColor||"#ffffff",displayMode:config.displayMode||"carousel"};Gamblio.backgroundType=Gamblio.recommendationConfig.backgroundType;Gamblio.shadowColor=Gamblio.recommendationConfig.shadowColor;Gamblio.gradientColors=Gamblio.recommendationConfig.gradientColors;Gamblio.gradientDirection=Gamblio.recommendationConfig.gradientDirection;Gamblio.videoIndex=Gamblio.recommendationConfig.videoIndex;Gamblio.imageIndex=Gamblio.recommendationConfig.imageIndex;Gamblio.imageExtension=Gamblio.recommendationConfig.imageExtension;Gamblio.navButtonColor=Gamblio.recommendationConfig.navButtonColor;Gamblio.navButtonHoverColor=Gamblio.recommendationConfig.navButtonHoverColor;Gamblio.displayMode=Gamblio.recommendationConfig.displayMode;Gamblio.clientId=props.clientId;Gamblio.recommendationWidgetTargetContainerId=props.recommendationWidgetTargetContainerId;console.log(Gamblio.isVip,"IS VIP IP IPIPIP");if(language){Gamblio.language=language}const resolvedToken=Gamblio.resolveToken(tokenName);if(resolvedToken){Gamblio.token=resolvedToken;Gamblio.isVip=await Gamblio.determineVipStatus(resolvedToken);Gamblio.addChatWidget();Gamblio.addRecommendationWidget();return}Gamblio.addChatWidget()}static getCookie(name){const value=`; ${document.cookie}`;const parts=value.split(`; ${name}=`);if(parts.length===2)return parts.pop().split(";").shift()}static getTokenFromLocalStorage(name){if(!name||typeof window==="undefined")return undefined;try{return window.localStorage?.getItem(name)||undefined}catch(err){console.warn(`[Gamblio] Unable to read token "${name}" from localStorage.`,err);return undefined}}static resolveToken(tokenName){if(!tokenName){return undefined}const normalizedTokenName=typeof tokenName==="string"?tokenName.trim():undefined;let token;if(normalizedTokenName){token=Gamblio.getTokenFromLocalStorage(normalizedTokenName);if(token){return token}token=Gamblio.getCookie(normalizedTokenName);if(token){return token}}return undefined}static async determineVipStatus(token){if(!token)return false;try{const response=await fetch(`${CONFIG.apiUrl}/api/accounts/is_vip_player?token=${token}`);if(!response.ok){console.warn("[Gamblio] Failed to check VIP status. Falling back to non-VIP.");return false}const data=await response.json();if(typeof data==="boolean"){return data}if(typeof data?.isVip==="boolean"){return data.isVip}if(typeof data?.is_vip==="boolean"){return data.is_vip}}catch(err){console.warn("[Gamblio] Error while checking VIP status.",err)}return false}static addChatWidget(){GamblioChatWidget.init()}static addRecommendationWidget(){GamblioRecommendationWidget.init()}}class GamblioChatWidget{static HTML=`\n    <button class="chat-toggle" id="chatToggle" aria-label="Open chat with Admiral Bot" aria-expanded="false" aria-controls="chatContainer">\n      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true">\n        <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM20 16H5.17L4 17.17V4H20V16Z"></path>\n        <circle cx="7" cy="10" r="1"></circle>\n        <circle cx="12" cy="10" r="1"></circle>\n        <circle cx="17" cy="10" r="1"></circle>\n      </svg>\n    </button>\n    <div class="nx-chat-container" id="chatContainer" role="dialog" aria-label="Admiral Bot Chat" aria-hidden="true">\n      <div class="nx-chat-header">\n        <div class="nx-chat-header-content">\n          <img src="https://www.admiralbet.ba/assets/images/cms/ABBijeli.png" alt="Admiral Bot logo">\n          <div id="typingBubble" class="typing-bubble" aria-hidden="true">\n            <div class="typing-dots">\n              <span></span>\n              <span></span>\n              <span></span>\n            </div>\n          </div>\n        </div>\n        <div class="chat-navigation">\n          <button id="endChat" type="button" class="end-chat" style="display:none;">End chat</button>\n          <button class="nx-chat-close" id="chatClose" type="button" aria-label="Close chat">\n            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true">\n              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>\n            </svg>\n          </button>\n        </div>\n      </div>\n      <div class="nx-chat-body" role="log" aria-live="polite">\n        <div id="preChatContainer" class="pre-chat-container">\n          <label for="preChatInput">Enter your name or email (optional)</label>\n          <input id="preChatInput" type="text" class="pre-chat-input" autocomplete="off" placeholder="Enter your name or email...">\n          <button id="startChatButton" type="button" class="pre-chat-button">Start Chat</button>\n        </div>\n        <div class="messages" id="messagesContainer"></div>\n      </div>\n      <div class="nx-chat-footer" id="nxChatFooter">\n        <div id="chatClosedMessage" class="chat-closed-message" style="display:none;">\n          <p>This chat is closed</p>\n          <button id="reopenChatButton" type="button">Reopen chat</button>\n        </div>\n        <div id="filePreview" class="file-preview" style="display:none;">\n          <div class="file-preview-content">\n            <img id="previewImage" alt="Attachment preview">\n            <span class="file-preview-name">Image selected</span>\n            <button id="removeFile" type="button" class="remove-file-btn">Remove</button>\n          </div>\n        </div>\n        <div id="messageForm" class="message-form">\n          <input id="chatInput" type="text" class="nx-chat-input" autocomplete="off" placeholder="Connecting..." aria-label="Message input" disabled>\n          <button id="emojiButton" type="button" class="emoji-button" aria-label="Add emoji">\n            <svg viewBox="0 0 24 24" width="20" height="20" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true" fill="currentColor">\n              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"></path>\n              <circle cx="8.5" cy="10.5" r="1.5"></circle>\n              <circle cx="15.5" cy="10.5" r="1.5"></circle>\n              <path d="M12 17.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"></path>\n            </svg>\n          </button>\n          <emoji-picker id="emojiPicker" style="display:none;"></emoji-picker>\n          <label id="fileUploadButton" class="file-upload-btn" aria-label="Upload image">\n            <input id="fileInput" type="file" accept="image/*">\n            <div class="file-upload-icon">\n              <svg viewBox="0 0 24 24" width="20" height="20" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true" fill="currentColor">\n                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"></path>\n              </svg>\n            </div>\n          </label>\n          <button id="sendButton" type="button" class="send-button" aria-label="Send message" disabled>\n            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true">\n              <path fill-rule="evenodd" clip-rule="evenodd" d="M3.3938 2.20468C3.70395 1.96828 4.12324 1.93374 4.4679 2.1162L21.4679 11.1162C21.7953 11.2895 22 11.6296 22 12C22 12.3704 21.7953 12.7105 21.4679 12.8838L4.4679 21.8838C4.12324 22.0662 3.70395 22.0317 3.3938 21.7953C3.08365 21.5589 2.93922 21.1637 3.02382 20.7831L4.97561 12L3.02382 3.21692C2.93922 2.83623 3.08365 2.44109 3.3938 2.20468ZM6.80218 13L5.44596 19.103L16.9739 13H6.80218ZM16.9739 11H6.80218L5.44596 4.89699L16.9739 11Z"></path>\n            </svg>\n          </button>\n        </div>\n      </div>\n    </div>\n  `;static CSS=`\n.chat-toggle,\n.nx-chat-container {\n  font-family: "Geist", sans-serif;\n}\n\n.chat-toggle {\n  position: fixed;\n  bottom: 20px;\n  right: 20px;\n  width: 60px;\n  height: 60px;\n  background: #002157;\n  border-radius: 50%;\n  border: none;\n  color: #ffffff;\n  cursor: pointer;\n  box-shadow: 0 4px 20px rgba(0, 33, 87, 0.3);\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  z-index: 1001;\n  transition: transform 0.3s ease, box-shadow 0.3s ease;\n}\n\n.chat-toggle:hover {\n  transform: scale(1.1);\n  box-shadow: 0 6px 26px rgba(0, 33, 87, 0.4);\n}\n\n.chat-toggle svg {\n  width: 28px;\n  height: 28px;\n  fill: currentColor;\n  transition: transform 0.3s ease;\n}\n\n.chat-toggle.active svg {\n  transform: rotate(45deg);\n}\n\n.nx-chat-container {\n  position: fixed;\n  bottom: 90px;\n  right: 20px;\n  width: 380px;\n  height: 500px;\n  background: #ffffff;\n  border: 1px solid #e6e6e6;\n  border-radius: 12px;\n  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.18);\n  display: flex;\n  flex-direction: column;\n  transform: translateY(20px) scale(0.95);\n  opacity: 0;\n  visibility: hidden;\n  pointer-events: none;\n  transition: transform 0.3s ease, opacity 0.3s ease, visibility 0.3s ease;\n  z-index: 1000;\n}\n\n.nx-chat-container.open {\n  transform: translateY(0) scale(1);\n  opacity: 1;\n  visibility: visible;\n  pointer-events: auto;\n}\n\n.nx-chat-container,\n.nx-chat-container * {\n  box-sizing: border-box;\n  font-family: "Geist", sans-serif;\n}\n\n.nx-chat-header {\n  background: #002157;\n  color: #ffffff;\n  padding: 16px 20px;\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  border-radius: 12px 12px 0 0;\n}\n\n.nx-chat-header-content {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  gap: 8px;\n}\n\n.nx-chat-header img {\n  width: 110px;\n  height: auto;\n}\n\n.chat-navigation {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n}\n\n.nx-chat-close,\n.end-chat {\n  background: none;\n  border: none;\n  color: inherit;\n  cursor: pointer;\n  padding: 4px 8px;\n  border-radius: 6px;\n  transition: background-color 0.2s ease;\n  display: flex;\n  align-items: center;\n  gap: 4px;\n}\n\n.end-chat {\n  border: 1px solid rgba(255, 255, 255, 0.8);\n  font-size: 0.8rem;\n}\n\n.nx-chat-close:hover,\n.end-chat:hover {\n  background-color: rgba(255, 255, 255, 0.12);\n}\n\n.nx-chat-close svg {\n  width: 20px;\n  height: 20px;\n  fill: currentColor;\n}\n\n.nx-chat-body {\n  flex: 1;\n  background: #fafafa;\n  padding: 16px 20px;\n  display: flex;\n  flex-direction: column;\n  gap: 16px;\n  overflow-y: auto;\n}\n\n.nx-chat-body::-webkit-scrollbar {\n  width: 0;\n  height: 0;\n}\n\n.pre-chat-container {\n  display: flex;\n  flex-direction: column;\n  gap: 12px;\n  background: #ffffff;\n  border-radius: 12px;\n  border: 1px solid #e6e6e6;\n  padding: 20px;\n  box-shadow: 0 12px 28px rgba(0, 33, 87, 0.12);\n  text-align: center;\n}\n\n.pre-chat-container label {\n  font-size: 0.9rem;\n  color: #2b2b2b;\n}\n\n.pre-chat-input {\n  border: 1px solid #dcdcdc;\n  border-radius: 20px;\n  padding: 12px 16px;\n  font-size: 0.95rem;\n}\n\n.pre-chat-input:focus {\n  outline: none;\n  border-color: #002157;\n  box-shadow: 0 0 0 1px rgba(0, 33, 87, 0.15);\n}\n\n.pre-chat-button {\n  border: none;\n  border-radius: 20px;\n  padding: 12px 20px;\n  background: #002157;\n  color: #ffffff;\n  font-size: 0.95rem;\n  cursor: pointer;\n  transition: background 0.2s ease, transform 0.2s ease;\n}\n\n.pre-chat-button:hover {\n  background: #003580;\n  transform: scale(1.03);\n}\n\n.messages {\n  display: flex;\n  flex-direction: column;\n  gap: 12px;\n  flex: 1;\n  min-height: 0;\n}\n\n.message-wrapper {\n  display: flex;\n  flex-direction: column;\n  gap: 4px;\n  max-width: 85%;\n}\n\n.message-wrapper.user {\n  align-self: flex-end;\n  align-items: flex-end;\n}\n\n.message-wrapper.bot {\n  align-self: flex-start;\n  align-items: flex-start;\n}\n\n.message {\n  padding: 10px 14px;\n  border-radius: 14px;\n  line-height: 1.45;\n  font-size: 0.95rem;\n  background: #ffffff;\n  color: #2c2c2c;\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);\n}\n\n.message.user {\n  background: #002157;\n  color: #ffffff;\n  border-bottom-right-radius: 4px;\n}\n\n.message.bot {\n  border-bottom-left-radius: 4px;\n}\n\n.message img {\n  margin-top: 8px;\n  border-radius: 8px;\n  max-width: 220px;\n  width: 100%;\n  height: auto;\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);\n  cursor: pointer;\n}\n\n.timestamp {\n  font-size: 0.75rem;\n  color: #7f7f7f;\n}\n\n.nx-chat-footer {\n  display: flex;\n  flex-direction: column;\n  gap: 8px;\n  padding: 16px 20px;\n  border-top: 1px solid #e6e6e6;\n  background: #ffffff;\n  border-radius: 0 0 12px 12px;\n}\n\n.chat-closed-message {\n  text-align: center;\n}\n\n.chat-closed-message button {\n  margin-top: 8px;\n  border: none;\n  border-radius: 20px;\n  padding: 8px 16px;\n  background: #002157;\n  color: #ffffff;\n  cursor: pointer;\n  transition: background 0.2s ease;\n}\n\n.chat-closed-message button:hover {\n  background: #003580;\n}\n\n.file-preview {\n  display: none;\n  border: 1px solid #e6e6e6;\n  border-radius: 8px;\n  background: #f5f5f5;\n  padding: 10px 14px;\n}\n\n.file-preview-content {\n  display: flex;\n  align-items: center;\n  gap: 12px;\n}\n\n.file-preview img {\n  width: 48px;\n  height: 48px;\n  border-radius: 6px;\n  object-fit: cover;\n  border: 1px solid #dcdcdc;\n}\n\n.remove-file-btn {\n  background: #c0392b;\n  color: #ffffff;\n  border: none;\n  border-radius: 6px;\n  padding: 6px 12px;\n  font-size: 0.8rem;\n  cursor: pointer;\n  transition: background 0.2s ease;\n}\n\n.remove-file-btn:hover {\n  background: #962d22;\n}\n\n.message-form {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  position: relative;\n}\n\n.nx-chat-input {\n  flex: 1;\n  border: 1px solid #dcdcdc;\n  border-radius: 20px;\n  padding: 12px 16px;\n  font-size: 0.95rem;\n}\n\n.nx-chat-input:focus {\n  outline: none;\n  border-color: #002157;\n  box-shadow: 0 0 0 1px rgba(0, 33, 87, 0.2);\n}\n\n.emoji-button,\n.file-upload-icon,\n.send-button {\n  width: 36px;\n  height: 36px;\n  border-radius: 50%;\n  background: #002157;\n  border: none;\n  color: #ffffff;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  cursor: pointer;\n  transition: background 0.2s ease, transform 0.2s ease;\n}\n\n.emoji-button:hover,\n.file-upload-icon:hover,\n.send-button:hover {\n  background: #003580;\n  transform: scale(1.05);\n}\n\n.emoji-button svg,\n.file-upload-icon svg,\n.send-button svg {\n  width: 20px;\n  height: 20px;\n  fill: currentColor;\n}\n\n.file-upload-btn input {\n  display: none;\n}\n\n.typing-bubble {\n  display: none;\n  align-items: center;\n  gap: 6px;\n  font-size: 0.85rem;\n  color: rgba(255, 255, 255, 0.9);\n}\n\n.typing-dots {\n  display: flex;\n  gap: 4px;\n}\n\n.typing-dots span {\n  width: 6px;\n  height: 6px;\n  background: #fecc00;\n  border-radius: 50%;\n  animation: typing-dot 1.2s infinite ease-in-out;\n}\n\n.typing-dots span:nth-child(2) {\n  animation-delay: 0.2s;\n}\n\n.typing-dots span:nth-child(3) {\n  animation-delay: 0.4s;\n}\n\n@keyframes typing-dot {\n  0%, 80%, 100% {\n    transform: scale(0.7);\n    opacity: 0.5;\n  }\n  40% {\n    transform: scale(1);\n    opacity: 1;\n  }\n}\n\n.nx-date-separator {\n  display: flex;\n  align-items: center;\n  gap: 10px;\n  font-size: 0.75rem;\n  color: #8c8c8c;\n  text-transform: uppercase;\n  letter-spacing: 0.08em;\n}\n\n.nx-date-separator-label {\n  font-weight: 600;\n}\n\n.nx-separator-line {\n  flex: 1 0 0;\n  height: 1px;\n  background: #dedede;\n}\n\nemoji-picker {\n  position: absolute;\n  bottom: 48px;\n  right: 0;\n  z-index: 2000;\n  max-height: 260px;\n  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);\n}\n\n@media (max-width: 768px) {\n  .nx-chat-container {\n    width: calc(100% - 24px);\n    bottom: 80px;\n    right: 12px;\n    left: 12px;\n    height: 70vh;\n  }\n\n  .chat-toggle {\n    bottom: 16px;\n    right: 16px;\n  }\n\n  .message-wrapper {\n    max-width: 90%;\n  }\n\n  .message img {\n    max-width: 160px;\n  }\n}\n\n@media (max-width: 480px) {\n  .nx-chat-container {\n    width: calc(100% - 16px);\n    right: 8px;\n    left: 8px;\n    bottom: 70px;\n    height: 65vh;\n  }\n\n  .message img {\n    max-width: 120px;\n  }\n}\n`;static hasInitialized=false;static socket=null;static chatId=null;static token="";static clientId=null;static playerName="";static messages=[];static isSending=false;static shouldAutoScroll=true;static selectedFile=null;static previewObjectUrl=null;static typingTimeoutId=null;static elements={};static documentClickHandler=null;static init(){if(GamblioChatWidget.hasInitialized){return}GamblioChatWidget.hasInitialized=true;GamblioChatWidget.token=Gamblio.token||"";GamblioChatWidget.clientId=Gamblio.clientId??null;GamblioChatWidget.playerName=GamblioChatWidget.generateGuestName();GamblioChatWidget.injectAssets();GamblioChatWidget.cacheElements();GamblioChatWidget.resetUi();GamblioChatWidget.setupEventListeners();GamblioChatWidget.ensureEmojiPicker();window.addEventListener("beforeunload",GamblioChatWidget.handleBeforeUnload)}static injectAssets(){if(!document.getElementById("gamblio-chat-widget-style")){const style=document.createElement("style");style.id="gamblio-chat-widget-style";style.textContent=GamblioChatWidget.CSS;document.head.appendChild(style)}if(!document.getElementById("chatContainer")){const wrapper=document.createElement("div");wrapper.innerHTML=GamblioChatWidget.HTML.trim();while(wrapper.firstChild){document.body.appendChild(wrapper.firstChild)}}}static cacheElements(){GamblioChatWidget.elements={chatToggle:document.getElementById("chatToggle"),chatContainer:document.getElementById("chatContainer"),chatClose:document.getElementById("chatClose"),chatInput:document.getElementById("chatInput"),sendButton:document.getElementById("sendButton"),chatFooter:document.getElementById("nxChatFooter"),preChatContainer:document.getElementById("preChatContainer"),preChatInput:document.getElementById("preChatInput"),startChatButton:document.getElementById("startChatButton"),endChatButton:document.getElementById("endChat"),reopenChatButton:document.getElementById("reopenChatButton"),chatClosedMessage:document.getElementById("chatClosedMessage"),messagesContainer:document.getElementById("messagesContainer"),typingBubble:document.getElementById("typingBubble"),emojiButton:document.getElementById("emojiButton"),emojiPicker:document.getElementById("emojiPicker"),fileInput:document.getElementById("fileInput"),filePreview:document.getElementById("filePreview"),previewImage:document.getElementById("previewImage"),removeFile:document.getElementById("removeFile"),messageForm:document.getElementById("messageForm"),chatBody:document.querySelector(".nx-chat-body")}}static resetUi(){GamblioChatWidget.destroySocket();GamblioChatWidget.messages=[];GamblioChatWidget.chatId=null;GamblioChatWidget.shouldAutoScroll=true;GamblioChatWidget.isSending=false;GamblioChatWidget.selectedFile=null;GamblioChatWidget.clearTypingIndicator();const el=GamblioChatWidget.elements;if(el.messagesContainer){el.messagesContainer.innerHTML=""}if(el.chatClosedMessage){el.chatClosedMessage.style.display="none"}if(el.messageForm){el.messageForm.style.display="flex"}if(el.endChatButton){el.endChatButton.style.display="none"}if(el.startChatButton){el.startChatButton.disabled=false}if(el.chatFooter){el.chatFooter.style.display="none"}if(el.chatInput){el.chatInput.value="";el.chatInput.disabled=true;el.chatInput.placeholder=GamblioChatWidget.hasToken()?"Click to start conversation":"Enter your name to start"}if(el.sendButton){el.sendButton.disabled=true}GamblioChatWidget.updateFilePreview(null);if(el.preChatContainer){el.preChatContainer.style.display="block";const label=el.preChatContainer.querySelector("label");if(GamblioChatWidget.hasToken()){if(label){label.textContent="Click to start conversation"}if(el.preChatInput){el.preChatInput.value="";el.preChatInput.style.display="none"}}else{if(label){label.textContent="Enter your name or email (optional)"}if(el.preChatInput){el.preChatInput.value="";el.preChatInput.style.display=""}}}if(GamblioChatWidget.elements.emojiPicker){GamblioChatWidget.elements.emojiPicker.style.display="none"}GamblioChatWidget.setChatAriaState(false);el.chatToggle?.classList.remove("active");el.chatContainer?.classList.remove("open")}static setupEventListeners(){const el=GamblioChatWidget.elements;el.chatToggle?.addEventListener("click",()=>GamblioChatWidget.toggleChat());el.chatClose?.addEventListener("click",()=>GamblioChatWidget.closeChat());el.chatContainer?.addEventListener("click",event=>event.stopPropagation());el.startChatButton?.addEventListener("click",()=>GamblioChatWidget.startChat());el.preChatInput?.addEventListener("keypress",event=>{if(event.key==="Enter"){event.preventDefault();GamblioChatWidget.startChat()}});el.endChatButton?.addEventListener("click",()=>GamblioChatWidget.handleEndChat());el.reopenChatButton?.addEventListener("click",()=>GamblioChatWidget.resetUi());el.sendButton?.addEventListener("click",()=>GamblioChatWidget.sendMessage());el.chatInput?.addEventListener("keydown",event=>{if(event.key==="Enter"){event.preventDefault();GamblioChatWidget.sendMessage()}});el.chatInput?.addEventListener("input",()=>GamblioChatWidget.clearTypingIndicator());el.fileInput?.addEventListener("change",event=>GamblioChatWidget.handleFileSelect(event));el.removeFile?.addEventListener("click",()=>GamblioChatWidget.removeSelectedFile());el.emojiButton?.addEventListener("click",event=>{event.stopPropagation();GamblioChatWidget.toggleEmojiPicker()});if(el.emojiPicker){el.emojiPicker.addEventListener("emoji-click",event=>{if(!GamblioChatWidget.elements.chatInput){return}GamblioChatWidget.elements.chatInput.value+=event.detail.unicode;GamblioChatWidget.elements.chatInput.focus();GamblioChatWidget.elements.emojiPicker.style.display="none"})}if(!GamblioChatWidget.documentClickHandler){GamblioChatWidget.documentClickHandler=event=>{const picker=GamblioChatWidget.elements.emojiPicker;const button=GamblioChatWidget.elements.emojiButton;if(!picker||picker.style.display==="none"){return}if(button&&button.contains(event.target)){return}if(picker.contains(event.target)){return}picker.style.display="none"};document.addEventListener("click",GamblioChatWidget.documentClickHandler)}}static ensureEmojiPicker(){if(typeof customElements==="undefined"){return}if(customElements.get("emoji-picker")){return}if(document.getElementById("gamblio-emoji-picker-module")){return}const script=document.createElement("script");script.id="gamblio-emoji-picker-module";script.type="module";script.src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js";document.head.appendChild(script)}static hasToken(){return Boolean(GamblioChatWidget.token)}static toggleChat(){const el=GamblioChatWidget.elements;if(el.chatContainer?.classList.contains("open")){GamblioChatWidget.closeChat()}else{GamblioChatWidget.openChat()}}static openChat(){const el=GamblioChatWidget.elements;if(!el.chatContainer){return}el.chatContainer.classList.add("open");el.chatToggle?.classList.add("active");GamblioChatWidget.setChatAriaState(true);GamblioChatWidget.ensureEmojiPicker();if(GamblioChatWidget.hasToken()&&!GamblioChatWidget.socket){GamblioChatWidget.startChat(true)}setTimeout(()=>{GamblioChatWidget.shouldAutoScroll=true;GamblioChatWidget.renderMessages();GamblioChatWidget.shouldAutoScroll=false;el.chatInput?.focus()},250)}static closeChat(){const el=GamblioChatWidget.elements;if(!el.chatContainer){return}el.chatContainer.classList.remove("open");el.chatToggle?.classList.remove("active");GamblioChatWidget.setChatAriaState(false)}static setChatAriaState(open){const el=GamblioChatWidget.elements;el.chatToggle?.setAttribute("aria-expanded",open?"true":"false");el.chatContainer?.setAttribute("aria-hidden",open?"false":"true")}static startChat(auto=false){if(GamblioChatWidget.socket&&GamblioChatWidget.socket.readyState===WebSocket.OPEN){return}if(!GamblioChatWidget.hasToken()){const value=(GamblioChatWidget.elements.preChatInput?.value||"").trim();if(!value&&auto){return}GamblioChatWidget.playerName=value||GamblioChatWidget.generateGuestName()}if(GamblioChatWidget.elements.startChatButton){GamblioChatWidget.elements.startChatButton.disabled=true}if(GamblioChatWidget.elements.preChatContainer){GamblioChatWidget.elements.preChatContainer.style.display="none"}if(GamblioChatWidget.elements.chatFooter){GamblioChatWidget.elements.chatFooter.style.display="flex"}GamblioChatWidget.messages=[];GamblioChatWidget.renderMessages();GamblioChatWidget.setChatInputEnabled(false,"Connecting...");GamblioChatWidget.createWebSocket()}static createWebSocket(){const url=GamblioChatWidget.resolveWebSocketUrl();if(!url){console.warn("[Gamblio][Chat] Missing CONFIG.wsUrl for chat");GamblioChatWidget.setChatInputEnabled(false,"Connection unavailable");return}GamblioChatWidget.destroySocket();try{const socket=new WebSocket(url);GamblioChatWidget.socket=socket;socket.addEventListener("open",()=>{GamblioChatWidget.sendSocketMessage({tag:"playerStartChatAndJoin",playerToken:GamblioChatWidget.token||null,clientId:GamblioChatWidget.clientId??null,playerName:GamblioChatWidget.playerName||""})});socket.addEventListener("message",event=>GamblioChatWidget.handleSocketMessage(event));socket.addEventListener("error",event=>{console.warn("[Gamblio][Chat] WebSocket error",event)});socket.addEventListener("close",()=>{GamblioChatWidget.socket=null;GamblioChatWidget.setChatInputEnabled(false,"Connection lost")})}catch(error){console.error("[Gamblio][Chat] Unable to open WebSocket",error);GamblioChatWidget.setChatInputEnabled(false,"Connection error")}}static resolveWebSocketUrl(){if(CONFIG.wsUrl){const trimmed=CONFIG.wsUrl.replace(/\/$/,"");return trimmed.endsWith("/ws/chat")?trimmed:`${trimmed}/ws/chat`}if(CONFIG.apiUrl){try{const base=new URL(CONFIG.apiUrl);base.protocol=base.protocol==="https:"?"wss:":"ws:";return`${base.origin}/ws/chat`}catch(error){console.warn("[Gamblio][Chat] Invalid CONFIG.apiUrl",error)}}return null}static sendSocketMessage(payload){if(!GamblioChatWidget.socket||GamblioChatWidget.socket.readyState!==WebSocket.OPEN){console.warn("[Gamblio][Chat] Tried to send message while socket not open");return}GamblioChatWidget.socket.send(JSON.stringify(payload))}static handleSocketMessage(event){let data;try{data=JSON.parse(event.data)}catch(error){console.warn("[Gamblio][Chat] Failed to parse message",error);return}if(data.tag==="bump"){GamblioChatWidget.handleBumpMessage(data);return}if(data.tag==="existingMessages"){GamblioChatWidget.handleExistingMessages(data);return}console.info("[Gamblio][Chat] Unhandled message",data)}static handleBumpMessage(payload){const data=payload.bump_data||{};switch(payload.bump_type){case"startChatSuccess":GamblioChatWidget.chatId=data.chat??data.chatId??null;GamblioChatWidget.handleChatReady();break;case"newMessage":GamblioChatWidget.clearTypingIndicator();if(data.is_sent_safely===true){break}GamblioChatWidget.pushMessage({role:data.role,content:data.text,attachment:data.attachment_url,unix:Number(data.timestamp)||Math.floor(Date.now()/1e3)});break;case"switchedStatusToClosed":GamblioChatWidget.handleChatClosed();break;default:console.info("[Gamblio][Chat] Unknown bump type",payload)}}static handleExistingMessages(payload){const incoming=Array.isArray(payload.messages)?payload.messages:[];GamblioChatWidget.messages=incoming.filter(msg=>msg&&msg.role!=="system_event"&&msg.is_sent_safely!==true).map(msg=>({role:msg.role,content:msg.content,attachment:msg.attachment_url,unix:Number(msg.timestamp)||Math.floor(Date.now()/1e3)}));if(payload.chat_id){GamblioChatWidget.chatId=payload.chat_id;GamblioChatWidget.handleChatReady()}GamblioChatWidget.renderMessages()}static handleChatReady(){GamblioChatWidget.setChatInputEnabled(true,"Type your message...");GamblioChatWidget.elements.endChatButton?.style.setProperty("display","block");if(GamblioChatWidget.elements.startChatButton){GamblioChatWidget.elements.startChatButton.disabled=false}GamblioChatWidget.elements.chatInput?.focus()}static handleChatClosed(){GamblioChatWidget.clearTypingIndicator();GamblioChatWidget.setChatInputEnabled(false,"Chat closed");GamblioChatWidget.elements.messageForm?.style.setProperty("display","none");GamblioChatWidget.elements.chatClosedMessage?.style.setProperty("display","block");GamblioChatWidget.elements.endChatButton?.style.setProperty("display","none");if(GamblioChatWidget.elements.startChatButton){GamblioChatWidget.elements.startChatButton.disabled=false}GamblioChatWidget.removeSelectedFile();GamblioChatWidget.chatId=null;GamblioChatWidget.destroySocket()}static pushMessage(message){if(!message){return}GamblioChatWidget.messages.push({role:message.role||"bot",content:message.content||"",attachment:message.attachment||null,unix:message.unix||Math.floor(Date.now()/1e3)});GamblioChatWidget.renderMessages()}static renderMessages(){const el=GamblioChatWidget.elements;if(!el.messagesContainer){return}const scrollContainer=el.chatBody||el.messagesContainer;const atBottom=Math.abs(scrollContainer.scrollHeight-scrollContainer.scrollTop-scrollContainer.clientHeight)<=5;el.messagesContainer.innerHTML="";let lastDay=null;GamblioChatWidget.messages.forEach(msg=>{const day=GamblioChatWidget.dayKey(msg.unix);if(day!==lastDay){lastDay=day;el.messagesContainer.appendChild(GamblioChatWidget.buildDateSeparator(msg.unix))}el.messagesContainer.appendChild(GamblioChatWidget.buildMessageElement(msg))});if(GamblioChatWidget.shouldAutoScroll||atBottom){scrollContainer.scrollTop=scrollContainer.scrollHeight}}static buildDateSeparator(unixSeconds){const wrapper=document.createElement("div");wrapper.className="nx-date-separator";const lineLeft=document.createElement("div");lineLeft.className="nx-separator-line";const label=document.createElement("span");label.className="nx-date-separator-label";label.textContent=GamblioChatWidget.formatDateLabel(unixSeconds);const lineRight=document.createElement("div");lineRight.className="nx-separator-line";wrapper.append(lineLeft,label,lineRight);return wrapper}static buildMessageElement(message){const wrapper=document.createElement("div");wrapper.className=`message-wrapper ${message.role==="player"?"user":"bot"}`;const bubble=document.createElement("div");bubble.className=`message ${message.role==="player"?"user":"bot"}`;const text=GamblioChatWidget.escapeHtml(message.content||"").replace(/\n/g,"<br>");bubble.innerHTML=text;if(message.attachment){const img=document.createElement("img");img.src=message.attachment;img.alt="Message attachment";img.addEventListener("click",()=>window.open(message.attachment,"_blank"));bubble.appendChild(img)}const timestamp=document.createElement("span");timestamp.className="timestamp";timestamp.textContent=GamblioChatWidget.formatTimestamp(message.unix);timestamp.title=GamblioChatWidget.formatTimestampTitle(message.unix);if(message.role==="player"){wrapper.append(bubble,timestamp)}else{wrapper.append(timestamp,bubble)}return wrapper}static formatDateLabel(unixSeconds){const date=new Date(unixSeconds*1e3);const now=new Date;const startOfToday=new Date(now.getFullYear(),now.getMonth(),now.getDate()).getTime();const startOfThat=new Date(date.getFullYear(),date.getMonth(),date.getDate()).getTime();const diff=Math.floor((startOfToday-startOfThat)/(1e3*60*60*24));if(diff===0){return"Today"}if(diff===1){return"Yesterday"}return date.toLocaleDateString(undefined,{month:"short",day:"2-digit",year:"numeric"})}static formatTimestamp(unixSeconds){const date=new Date(unixSeconds*1e3);const now=new Date;if(date.toDateString()===now.toDateString()){return date.toLocaleTimeString("en-GB",{hour12:false,hour:"2-digit",minute:"2-digit",second:"2-digit"})}const diff=Math.floor((now-date)/(1e3*60*60*24));if(diff===1){return"1 day ago"}if(diff<7){return`${diff} days ago`}return date.toLocaleDateString()}static formatTimestampTitle(unixSeconds){const date=new Date(unixSeconds*1e3);return date.toLocaleString(undefined,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:false})}static escapeHtml(value){return(value||"").replace(/[&<>"']/g,char=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[char]))}static sendMessage(){if(!GamblioChatWidget.socket||GamblioChatWidget.socket.readyState!==WebSocket.OPEN){console.warn("[Gamblio][Chat] Cannot send message while socket is closed");return}if(!GamblioChatWidget.chatId){console.warn("[Gamblio][Chat] Cannot send message without chatId");return}const text=(GamblioChatWidget.elements.chatInput?.value||"").trim();if(!text&&!GamblioChatWidget.selectedFile){return}if(GamblioChatWidget.isSending){return}GamblioChatWidget.isSending=true;GamblioChatWidget.setChatInputEnabled(false);const finalize=()=>{GamblioChatWidget.finishSending();GamblioChatWidget.scheduleTypingIndicator()};if(GamblioChatWidget.selectedFile){const reader=new FileReader;reader.onload=()=>{GamblioChatWidget.sendSocketMessage({tag:"playerSendMessage",chatId:GamblioChatWidget.chatId,message:text||"Image attachment",attachment:reader.result});if(GamblioChatWidget.elements.chatInput){GamblioChatWidget.elements.chatInput.value=""}GamblioChatWidget.removeSelectedFile();finalize()};reader.onerror=()=>{console.warn("[Gamblio][Chat] Failed to read attachment");GamblioChatWidget.removeSelectedFile();finalize()};reader.readAsDataURL(GamblioChatWidget.selectedFile)}else{GamblioChatWidget.sendSocketMessage({tag:"playerSendMessage",chatId:GamblioChatWidget.chatId,message:text,attachment:null});if(GamblioChatWidget.elements.chatInput){GamblioChatWidget.elements.chatInput.value=""}finalize()}}static finishSending(){GamblioChatWidget.isSending=false;if(GamblioChatWidget.chatId){GamblioChatWidget.setChatInputEnabled(true,"Type your message...");GamblioChatWidget.elements.chatInput?.focus()}}static handleFileSelect(event){const file=event.target.files&&event.target.files[0];if(!file){return}if(!file.type.startsWith("image/")){window.alert("Please select an image file");event.target.value="";return}if(file.size>5*1024*1024){window.alert("File size must be less than 5MB");event.target.value="";return}GamblioChatWidget.selectedFile=file;GamblioChatWidget.updateFilePreview(file)}static updateFilePreview(file){const el=GamblioChatWidget.elements;if(!el.filePreview){return}if(GamblioChatWidget.previewObjectUrl){URL.revokeObjectURL(GamblioChatWidget.previewObjectUrl);GamblioChatWidget.previewObjectUrl=null}if(!file){el.filePreview.style.display="none";if(el.previewImage){el.previewImage.src=""}return}const url=URL.createObjectURL(file);GamblioChatWidget.previewObjectUrl=url;el.filePreview.style.display="flex";if(el.previewImage){el.previewImage.src=url}}static removeSelectedFile(){GamblioChatWidget.selectedFile=null;if(GamblioChatWidget.elements.fileInput){GamblioChatWidget.elements.fileInput.value=""}GamblioChatWidget.updateFilePreview(null)}static scheduleTypingIndicator(){GamblioChatWidget.clearTypingIndicator();GamblioChatWidget.typingTimeoutId=window.setTimeout(()=>{GamblioChatWidget.setTypingIndicator(true)},4e3+Math.floor(Math.random()*3e3))}static clearTypingIndicator(){if(GamblioChatWidget.typingTimeoutId){window.clearTimeout(GamblioChatWidget.typingTimeoutId);GamblioChatWidget.typingTimeoutId=null}GamblioChatWidget.setTypingIndicator(false)}static setTypingIndicator(visible){const bubble=GamblioChatWidget.elements.typingBubble;if(!bubble){return}bubble.style.display=visible?"flex":"none"}static setChatInputEnabled(enabled,placeholder){const el=GamblioChatWidget.elements;if(el.chatInput){el.chatInput.disabled=!enabled;if(placeholder!==undefined){el.chatInput.placeholder=placeholder}}if(el.sendButton){el.sendButton.disabled=!enabled}}static sendCloseMessage(){if(!GamblioChatWidget.chatId){return}GamblioChatWidget.sendSocketMessage({tag:"playerLeaveChatAndClose",playerToken:GamblioChatWidget.token||null,chatId:GamblioChatWidget.chatId,clientId:GamblioChatWidget.clientId??null,playerName:GamblioChatWidget.playerName||""});GamblioChatWidget.chatId=null}static handleEndChat(){GamblioChatWidget.sendCloseMessage();GamblioChatWidget.handleChatClosed()}static handleBeforeUnload(){GamblioChatWidget.sendCloseMessage();GamblioChatWidget.destroySocket()}static destroySocket(){if(GamblioChatWidget.socket){try{GamblioChatWidget.socket.close()}catch(error){console.warn("[Gamblio][Chat] Failed to close socket",error)}GamblioChatWidget.socket=null}}static generateGuestName(){const letters="ABCDEFGHIJKLMNOPQRSTUVWXYZ";let suffix="";for(let i=0;i<4;i++){suffix+=letters.charAt(Math.floor(Math.random()*letters.length))}return`GUEST_${suffix}`}static dayKey(unixSeconds){const date=new Date(unixSeconds*1e3);return`${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()}`}static toggleEmojiPicker(){const picker=GamblioChatWidget.elements.emojiPicker;if(!picker){return}GamblioChatWidget.ensureEmojiPicker();picker.style.display=picker.style.display==="none"?"block":"none"}}class GamblioRecommendationWidget{static HTML="";static CSS="";static allGames=[];static currentIndex=0;static swiperInstance=null;static visibilityState=new Map;static lastActiveGameId=null;static observer=new IntersectionObserver(entries=>{entries.forEach(entry=>{const img=entry.target;const slideEl=img.closest(".swiper-slide");const isStackMode=Gamblio.displayMode==="stack";const isActiveSlide=slideEl?.classList.contains("swiper-slide-active")??false;const gameId=img.getAttribute("data-game-id");const game=GamblioRecommendationWidget.allGames.find(g=>String(g.normalizedId)===gameId);const stateKey=String(gameId);const wasVisible=GamblioRecommendationWidget.visibilityState.get(stateKey)===true;const isFullyVisible=entry.intersectionRatio>=1;const hasLeftViewport=!entry.isIntersecting;if(isStackMode&&!isActiveSlide){if(wasVisible){GamblioRecommendationWidget.visibilityState.set(stateKey,false)}return}if(!game){if(wasVisible&&hasLeftViewport){GamblioRecommendationWidget.visibilityState.set(stateKey,false)}return}if(isFullyVisible&&!wasVisible){GamblioRecommendationWidget.triggerImpression(game,{reason:"Fully visible in viewport; scheduling impression"})}else if(hasLeftViewport&&wasVisible){GamblioRecommendationWidget.visibilityState.set(stateKey,false)}})},{threshold:[0,1]});static triggerImpression(game,{reason:reason="Impression triggered",force:force=false}={}){if(!game){return}const stateKey=String(game.normalizedId);const wasVisible=GamblioRecommendationWidget.visibilityState.get(stateKey)===true;if(!force&&wasVisible){return}GamblioRecommendationWidget.visibilityState.set(stateKey,true);console.log(`[Gamblio][Recommendation] ${reason}`,{gameId:String(game.normalizedId),name:game.displayName});GamblioRecommendationWidget.addImpression(game.normalizedId)}static handleActiveStackSlide(swiper){const activeSlide=swiper.slides?.[swiper.activeIndex];if(!activeSlide)return;const img=activeSlide.querySelector("img[data-game-id]");if(!img)return;const gameId=img.getAttribute("data-game-id");const game=GamblioRecommendationWidget.allGames.find(g=>String(g.normalizedId)===gameId);if(GamblioRecommendationWidget.lastActiveGameId&&GamblioRecommendationWidget.lastActiveGameId!==gameId){GamblioRecommendationWidget.visibilityState.set(GamblioRecommendationWidget.lastActiveGameId,false)}GamblioRecommendationWidget.triggerImpression(game,{reason:"Active stack slide; scheduling impression"});GamblioRecommendationWidget.lastActiveGameId=gameId}static getBackgroundStyle(){const bgType=Gamblio.backgroundType;if(bgType==="gradient"){return"background: linear-gradient(var(--gradient-direction), var(--gradient-color-1), var(--gradient-color-2));"}else if(bgType==="video"||bgType==="image"){return"background: transparent;"}else{return"background: transparent;"}}static getVideoHTML(){if(Gamblio.backgroundType!=="video"){return""}const videoIndex=Gamblio.videoIndex||1;const videoFiles=[`video${videoIndex}.mp4`];const videoFile=videoFiles[videoIndex-1]||videoFiles[0];return`<video autoplay loop muted playsinline>\n      <source src="./videos/${videoFile}" type="video/mp4">\n    </video>`}static getImageHTML(){if(Gamblio.backgroundType!=="image"){return""}const imageIndex=Gamblio.imageIndex||1;const fileName=`image${imageIndex}.jpg`;return`<img class="background-image" src="./images/${fileName}" alt="Recommendation background image">`}static loadTemplate(){const isStackMode=Gamblio.displayMode==="stack";GamblioRecommendationWidget.HTML=`\n      <div id="game-container" class="${isStackMode?"stack-mode":""}">\n        ${GamblioRecommendationWidget.getVideoHTML()}\n        ${GamblioRecommendationWidget.getImageHTML()}\n     \n        <button id="prev-btn" class="nav-btn swiper-button-prev">\n        </button>\n\n        <div class="swiper${isStackMode?" stack-mode":""}" id="games-swiper">\n          <div class="swiper-wrapper" id="slider"></div>\n        </div>\n\n        <button id="next-btn" class="nav-btn swiper-button-next">\n        \n        </button>\n      </div>\n    `;GamblioRecommendationWidget.CSS=`\n      :root {\n        --card-shadow-color: ${Gamblio.shadowColor};\n        --gradient-color-1: ${Gamblio.gradientColors[0]};\n        --gradient-color-2: ${Gamblio.gradientColors[1]};\n        --gradient-direction: ${Gamblio.gradientDirection};\n        --nav-button-color: ${Gamblio.navButtonColor};\n        --nav-button-hover-color: ${Gamblio.navButtonHoverColor};\n      }\n\n      #game-container {\n        display: flex;\n        justify-content: center;\n        gap: 1rem;\n        width: 100%;\n        height: 100%;\n        padding-inline: 1rem;\n        position: relative;\n        ${GamblioRecommendationWidget.getBackgroundStyle()}\n      }\n\n      #game-container.stack-mode {\n        perspective: 1200px;\n      }\n\n      #game-container video {\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        object-fit: cover;\n        z-index: -1;\n      }\n\n      #game-container .background-image {\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        object-fit: cover;\n        z-index: -1;\n        pointer-events: none;\n      }\n\n      /* Swiper Container */\n      .swiper {\n        width: 100%;\n        height: 100%;\n        padding: 1rem 0;\n      }\n\n      .swiper.stack-mode {\n        width: 100%;\n        height: 100%;\n      }\n\n      .swiper-wrapper {\n        display: flex;\n        align-items: center;\n      }\n\n      .swiper-slide {\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        width: auto !important;\n        height: calc(100% - 2rem);\n      }\n\n      /* Game Cards */\n      .game {\n        width: auto;\n        height: 100%;\n        max-height: 100%;\n        aspect-ratio: 1;\n        position: relative;\n        border-radius: 12px;\n        overflow: hidden;\n        cursor: pointer;\n        box-shadow: 0 4px 16px var(--card-shadow-color);\n        transition: all 0.3s ease;\n      }\n\n      .game:hover {\n        transform: translateY(-8px);\n        box-shadow: 0 8px 24px var(--card-shadow-color);\n      }\n\n      .game img {\n        width: 100%;\n        height: 100%;\n        object-fit: cover;\n        border-radius: 12px;\n      }\n\n      .game::before {\n        content: "";\n        position: absolute;\n        inset: 0;\n        background: rgba(0, 0, 0, 0.7);\n        opacity: 0;\n        transition: opacity 0.3s ease;\n        z-index: 1;\n        border-radius: 12px;\n      }\n\n      .game:hover::before {\n        opacity: 1;\n      }\n\n      .game-hover-buttons {\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n        opacity: 0;\n        transition: opacity 0.3s ease;\n        z-index: 2;\n        pointer-events: none;\n        width: calc(100% - 16px);\n        height: 50%;\n        padding: 0 8px;\n      }\n\n      .game:hover .game-hover-buttons {\n        opacity: 1;\n        pointer-events: auto;\n      }\n\n      .game-hover-btn {\n        width: 100%;\n        flex: 1;\n        border: none;\n        border-radius: 6px;\n        font-size: clamp(16px, 2.5vw, 20px);\n        font-weight: 700;\n        text-transform: uppercase;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        color: white;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        letter-spacing: 1px;\n        white-space: nowrap;\n      }\n\n      .game-hover-btn.demo-btn {\n        background: #808080 !important;\n        color: white !important;\n      }\n\n      .game-hover-btn.demo-btn:hover {\n        background: #6b6b6b !important;\n      }\n\n      .game-hover-btn.play-btn {\n        background: #e6c328 !important;\n        color: #002157 !important;\n      }\n\n      .game-hover-btn.play-btn:hover {\n        background: #f2c944 !important;\n      }\n\n      /* Navigation Buttons */\n      .nav-btn {\n        position: relative;\n        z-index: 10;\n        background: transparent;\n        border: none;\n        border-radius: 50%;\n        width: 40px;\n        height: 40px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        transition: all 0.3s ease;\n        flex-shrink: 0;\n      }\n\n      .swiper-button-prev::after,\n      .swiper-button-next::after {\n        color: var(--nav-button-color);\n        font-size: 16px;\n        font-weight: bold;\n        transition: color 0.3s ease;\n      }\n\n      .swiper-button-prev:hover::after,\n      .swiper-button-next:hover::after {\n        color: var(--nav-button-hover-color);\n      }\n\n      .nav-btn.swiper-button-disabled {\n        opacity: 0.35;\n        cursor: not-allowed;\n      }\n\n      .nav-btn.swiper-button-disabled:hover::after {\n        color: var(--nav-button-color);\n      }\n\n      /* Mobile Responsiveness */\n      @media (max-width: 768px) {\n        #prev-btn,\n        #next-btn {\n          display: none !important;\n        }\n      }\n\n      /* Stack Mode - Half-Full-Half 3D Card Effect */\n      .swiper.stack-mode .swiper-slide {\n        width: 100% !important;\n        max-width: 350px;\n        height: 100%;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        position: relative;\n        transition: transform 0.4s ease, opacity 0.4s ease;\n      }\n\n      .swiper.stack-mode .swiper-slide .game {\n        width: 100%;\n        height: 100%;\n        border-radius: 16px;\n        overflow: hidden;\n        position: relative;\n        transition: box-shadow 0.3s ease, transform 0.3s ease;\n      }\n\n      #game-container.stack-mode .game {\n        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.45);\n      }\n\n      #game-container.stack-mode .game:hover {\n        transform: none;\n        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.45);\n      }\n\n      .swiper.stack-mode .swiper-slide-prev,\n      .swiper.stack-mode .swiper-slide-next {\n        z-index: 1;\n      }\n\n      .swiper.stack-mode .swiper-slide-prev .game,\n      .swiper.stack-mode .swiper-slide-next .game {\n        transform: translateZ(-60px) scale(0.9);\n        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);\n      }\n\n      .swiper.stack-mode .swiper-slide-prev .game::after,\n      .swiper.stack-mode .swiper-slide-next .game::after {\n        content: "";\n        position: absolute;\n        inset: 0;\n        background: linear-gradient(\n          180deg,\n          rgba(0, 0, 0, 0.60),\n          rgba(0, 0, 0, 0.7)\n        );\n        opacity: 0.85;\n        z-index: 3;\n        pointer-events: none;\n        transition: opacity 0.3s ease;\n      }\n\n      .swiper.stack-mode .swiper-slide:not(.swiper-slide-prev):not(.swiper-slide-active):not(.swiper-slide-next) {\n        opacity: 0;\n      }\n\n      .swiper.stack-mode .swiper-slide-active {\n        width: 100% !important;\n        max-width: 380px;\n        transform: translateZ(80px) scale(1.08);\n        z-index: 5;\n      }\n\n      .swiper.stack-mode .swiper-slide-active .game {\n        box-shadow: 0 20px 48px rgba(0, 0, 0, 0.55);\n      }\n\n      .swiper.stack-mode .swiper-slide-active .game::after {\n        content: "";\n        position: absolute;\n        inset: 0;\n        background: rgba(0, 0, 0, 0.50);\n        z-index: 3;\n        opacity: 0;\n        pointer-events: none;\n      }\n\n      .swiper.stack-mode .swiper-slide-prev .game-hover-buttons,\n      .swiper.stack-mode .swiper-slide-next .game-hover-buttons {\n        opacity: 0;\n        pointer-events: none;\n      }\n\n      .swiper.stack-mode .swiper-slide-active:hover .game-hover-buttons {\n        opacity: 1;\n        pointer-events: auto;\n      }\n\n      .swiper.stack-mode .swiper-slide-active:hover .game::before {\n        opacity: 0.35;\n      }\n    `;return true}static async init(){const templateLoaded=GamblioRecommendationWidget.loadTemplate();if(!templateLoaded)return;const res=await GamblioRecommendationWidget.getRecommendedGames();if(!res)return;const swiperCSS=document.createElement("link");swiperCSS.rel="stylesheet";swiperCSS.href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css";document.head.appendChild(swiperCSS);const swiperScript=document.createElement("script");swiperScript.src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js";swiperScript.onload=()=>{document.head.insertAdjacentHTML("beforeend",`<style>${GamblioRecommendationWidget.CSS}</style>`);document.getElementById(Gamblio.recommendationWidgetTargetContainerId).innerHTML=GamblioRecommendationWidget.HTML;setTimeout(()=>{GamblioRecommendationWidget.allGames=res.map(g=>{const normalizedId=g.id??g.gameId;const displayName=g.gameName||g.name||`Game ${normalizedId}`;return{...g,normalizedId:normalizedId,displayName:displayName}});GamblioRecommendationWidget.visibilityState.clear();GamblioRecommendationWidget.allGames.forEach(game=>{GamblioRecommendationWidget.visibilityState.set(String(game.normalizedId),false)});GamblioRecommendationWidget.lastActiveGameId=null;GamblioRecommendationWidget.renderCarousel();GamblioRecommendationWidget.initSwiper()},300)};document.head.appendChild(swiperScript)}static async getRecommendedGames(){try{const response=await fetch(`${CONFIG.apiUrl}/recommendation?clientId=${Gamblio.clientId}&playerToken=${Gamblio.token}`,{method:"GET",headers:{Accept:"application/json"}});if(!response.ok)throw new Error("Failed to load games");const res=await response.json();return res.data||res}catch(err){console.error("Error fetching games:",err);return[]}}static renderCarousel(){const slider=document.getElementById("slider");slider.innerHTML="";GamblioRecommendationWidget.allGames.forEach(game=>{const gameId=game.normalizedId;const gameName=game.displayName;const gameImage=game.gameImage||game.logo;GamblioRecommendationWidget.visibilityState.set(String(gameId),GamblioRecommendationWidget.visibilityState.get(String(gameId))===true);const slideEl=document.createElement("div");slideEl.classList.add("swiper-slide");slideEl.innerHTML=`\n        <div class="game">\n          <img src="${gameImage}" alt="${gameName}" data-game-id="${gameId}">\n          <div class="game-hover-buttons">\n            <button class="game-hover-btn demo-btn" data-action="demo">Demo</button>\n            <button class="game-hover-btn play-btn" data-action="play">Play</button>\n          </div>\n        </div>\n      `;const demoBtn=slideEl.querySelector(".demo-btn");const playBtn=slideEl.querySelector(".play-btn");demoBtn.addEventListener("click",e=>{e.stopPropagation();console.log("[Gamblio][Recommendation] Demo button clicked",{gameId:gameId,name:gameName});window.location.href="#"});playBtn.addEventListener("click",e=>{e.stopPropagation();console.log("[Gamblio][Recommendation] Play button clicked",{gameId:game.normalizedId,name:gameName});GamblioRecommendationWidget.addClick(game.normalizedId);window.location.href="#"});slider.appendChild(slideEl);GamblioRecommendationWidget.observer.observe(slideEl.querySelector("img"))})}static initSwiper(){const swiperContainer=document.getElementById("games-swiper");const gameContainer=document.getElementById("game-container");const requestedMode=Gamblio.displayMode||"carousel";const totalGames=GamblioRecommendationWidget.allGames.length;const effectiveMode=requestedMode==="stack"&&totalGames>=3?"stack":"carousel";if(effectiveMode==="stack"){swiperContainer.classList.add("stack-mode");gameContainer?.classList.add("stack-mode")}if(effectiveMode!=="stack"){swiperContainer.classList.remove("stack-mode");gameContainer?.classList.remove("stack-mode")}const swiperConfig={slidesPerView:"auto",spaceBetween:16,navigation:{nextEl:"#next-btn",prevEl:"#prev-btn"},keyboard:{enabled:true},mousewheel:{forceToAxis:true}};if(effectiveMode==="carousel"){swiperConfig.breakpoints={320:{spaceBetween:12},768:{spaceBetween:16},1024:{spaceBetween:20}}}if(effectiveMode==="stack"){swiperConfig.slidesPerView="auto";swiperConfig.loop=totalGames>3;swiperConfig.effect="coverflow";swiperConfig.grabCursor=true;swiperConfig.centeredSlides=true;swiperConfig.spaceBetween=0;swiperConfig.mousewheel=false;swiperConfig.coverflowEffect={rotate:0,stretch:0,depth:360,modifier:1.15,slideShadows:false}}const swiper=new Swiper("#games-swiper",swiperConfig);GamblioRecommendationWidget.swiperInstance=swiper;if(effectiveMode==="stack"){GamblioRecommendationWidget.handleActiveStackSlide(swiper);swiper.on("slideChange",()=>{GamblioRecommendationWidget.handleActiveStackSlide(swiper)})}else{GamblioRecommendationWidget.swiperInstance=null}}static addImpression(gameId){console.log("[Gamblio][Recommendation] Sending impression",{gameId:gameId});fetch(`${CONFIG.apiUrl}/api/recommendation/add-impression/?token=${Gamblio.token}&game_id=${gameId}`,{method:"POST"}).then(response=>{if(!response.ok){throw new Error(`HTTP ${response.status}`)}console.log("[Gamblio][Recommendation] Impression recorded",{gameId:gameId})}).catch(err=>console.warn("[Gamblio][Recommendation] Impression failed",{gameId:gameId,error:err}))}static addClick(gameId){console.log("[Gamblio][Recommendation] Sending click",{gameId:gameId});fetch(`${CONFIG.apiUrl}/api/recommendation/add-click/?token=${Gamblio.token}&game_id=${gameId}`,{method:"POST"}).then(response=>{if(!response.ok){throw new Error(`HTTP ${response.status}`)}console.log("[Gamblio][Recommendation] Click recorded",{gameId:gameId})}).catch(err=>console.warn("[Gamblio][Recommendation] Click failed",{gameId:gameId,error:err}))}}
